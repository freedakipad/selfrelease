<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>ä¸è±æ–¯ç‰¹å¯¹è¯ - è‡ªåœ¨é‡Šæ”¾</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.2/dist/purify.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet" />
    <style>
    :root{ --safe-bottom: env(safe-area-inset-bottom, 0px); --dock-height: 0px; --chat-height: 60vh; }
    body { font-family:'Noto Serif SC', 'Noto Sans SC', serif; font-size:15px; background:#F5F1EB; }
    .serif-font { font-family:'Ma Shan Zheng', cursive; }
    .glass { backdrop-filter: blur(10px); background: rgba(245,241,235,.86); }
    /* ç»Ÿä¸€é¡¶éƒ¨å¯¼èˆªç»ç’ƒæ•ˆæœ */
    .glass-effect {
      backdrop-filter: blur(10px);
      background: rgba(245, 241, 235, 0.8);
    }
    /* éŸ³ä¹æ§åˆ¶æŒ‰é’®ï¼ˆä¸é¦–é¡µä¸€è‡´ï¼‰ */
    #musicControlBtn {
      position: relative;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      cursor: pointer;
    }
    #musicControlBtn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      background: rgba(255, 255, 255, 1);
    }
    #musicControlBtn:active {
      transform: scale(0.95);
    }
    #musicControlBtn.playing {
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(236, 72, 153, 0.1));
      border-color: rgba(249, 115, 22, 0.3);
    }
    #musicControlBtn.playing::after {
      content: '';
      position: absolute;
      top: -3px;
      right: -3px;
      width: 10px;
      height: 10px;
      background: #10B981;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.95);
      animation: pulse 2s infinite;
    }
    .message-lester { background: linear-gradient(135deg, rgba(249,115,22,.08), rgba(236,72,153,.08)); border-left:3px solid #F97316; }
    .message-user { background: rgba(59,130,246,.08); border-right:3px solid #3B82F6; }
    .markdown-content { line-height: 1.8; }
    .markdown-content h1,.markdown-content h2,.markdown-content h3{ font-weight:600; margin:.75em 0 .5em; color:#374151 }
    .quick-questions { overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .quick-questions::-webkit-scrollbar{display:none}
    /* è¾“å…¥æ¡†è‡ªé€‚åº”é«˜åº¦ */
    #userInput, #userInputDesktop{ min-height:42px; max-height:40vh; overflow-y:auto; }
    /* æ¶ˆæ¯åŒºé«˜åº¦ç”±è„šæœ¬è®¡ç®—å†™å…¥ --chat-height */
    .chat-messages { height: var(--chat-height); }
    /* ç¦ç”¨æ€ */
    button[disabled]{ opacity:.5; cursor:not-allowed }
    /* Dock å®¹å™¨ï¼šç§»åŠ¨ç«¯å›ºå®šåº•éƒ¨ï¼ŒåŒ…å«è¾“å…¥åŒº+å¯¼èˆªï¼Œæ— ç¼è¿æ¥ */
    .bottom-dock { position: fixed; left:0; right:0; bottom:0; z-index: 40; background: rgba(245,241,235,.98); backdrop-filter: blur(10px); border-top: 1px solid rgba(200,200,200,.3); }
    .bottom-dock .input-section { border-bottom: 1px solid rgba(200,200,200,.2); }
    .bottom-dock .nav-section { 
      height: 56px; 
      padding: 8px 0;
    }
    .bottom-dock .nav-section a {
      padding: 4px 0;
      transition: all 0.2s;
    }
    .bottom-dock .nav-section a.active {
      border-top: 2px solid #F97316;
    }
    /* æ¡Œé¢ç«¯ï¼šDock éšè—ï¼Œè¾“å…¥åŒºåœ¨èŠå¤©ç›’å­å†… */
    @media (min-width: 769px){
      .bottom-dock { display: none; }
      .input-bar-desktop { position: sticky; bottom: 0; z-index: 10; }
    }
    /* ç§»åŠ¨ç«¯ï¼šéšè—æ¡Œé¢è¾“å…¥åŒº */
    @media (max-width: 768px){
      .input-bar-desktop { display: none; }
      nav .flex.space-x-8 { display: none; }
      .mobile-nav { display: flex !important; }
      main { padding-bottom: 90px; }
    }
    /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªï¼ˆç»Ÿä¸€æ ·å¼ï¼‰ */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(245, 241, 235, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.3);
      padding: 8px 0;
      z-index: 50;
    }
    .mobile-nav a {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      color: #6B7280;
      text-decoration: none;
      transition: all 0.2s;
      font-weight: 600;
    }
    .mobile-nav a.active {
      color: #F97316;
      border-top: 2px solid #F97316;
    }
    /* ç§»åŠ¨ç«¯é¢å¤–åº•éƒ¨ç•™ç™½ï¼Œé¿å…è¢«è¾“å…¥åŒº+åº•æ é®æŒ¡ */
    @media (max-width: 768px) {
      #mainContent {
        padding-bottom: calc(170px + var(--safe-bottom, 0px)) !important;
      }
      #chatMessages {
        padding-bottom: 100px !important;
      }
    }
    
    /* ä¼šè¯å†å²ä¾§æ  - æ¡Œé¢ç«¯ */
    .chat-sidebar { 
      position: fixed; 
      left: 0; 
      top: 64px; 
      bottom: 0; 
      width: 280px; 
      background: rgba(245,241,235,.95); 
      backdrop-filter: blur(10px); 
      border-right: 1px solid rgba(200,200,200,.3); 
      z-index: 30; 
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    .chat-sidebar.open { transform: translateX(0); }
    
    /* ç§»åŠ¨ç«¯ä¼šè¯å†å²æŠ½å±‰ */
    .chat-drawer {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 85%;
      max-width: 320px;
      background: rgba(245,241,235,.98);
      backdrop-filter: blur(10px);
      z-index: 60;
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,.1);
    }
    .chat-drawer.open { transform: translateX(0); }
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.3);
      z-index: 59;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .drawer-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    
    /* æ•°æ®åˆ†æé¢æ¿ - æ¡Œé¢ç«¯å¡ç‰‡ */
    .analytics-card {
      position: fixed;
      right: 20px;
      top: 80px;
      width: 320px;
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(200,200,200,.3);
      box-shadow: 0 4px 20px rgba(0,0,0,.1);
      z-index: 35;
      transform: translateX(calc(100% + 20px));
      transition: transform 0.3s ease;
    }
    .analytics-card.open { transform: translateX(0); }
    
    /* ç§»åŠ¨ç«¯æ•°æ®åˆ†æåº•éƒ¨æŠ½å±‰ */
    .analytics-drawer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-height: 70vh;
      background: rgba(255,255,255,.98);
      backdrop-filter: blur(10px);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      z-index: 50;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      box-shadow: 0 -4px 20px rgba(0,0,0,.1);
    }
    .analytics-drawer.open { transform: translateY(0); }
    .analytics-drawer-handle {
      width: 40px;
      height: 4px;
      background: #ccc;
      border-radius: 2px;
      margin: 8px auto;
    }
    
    /* ä¼šè¯é¡¹æ ·å¼ */
    .session-item {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(200,200,200,.2);
      cursor: pointer;
      transition: background 0.2s;
    }
    .session-item:hover { background: rgba(249,115,22,.1); }
    .session-item.active { background: rgba(249,115,22,.15); border-left: 3px solid #F97316; }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading-dots {
      display: inline-flex;
      gap: 4px;
    }
    .loading-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #F97316;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* é”™è¯¯æç¤º */
    .error-message {
      background: rgba(239,68,68,.1);
      border: 1px solid rgba(239,68,68,.3);
      color: #DC2626;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
    }
    /* éŸ³ä¹æ§åˆ¶æŒ‰é’®æ ·å¼å·²ç§»è‡³ navbar.js */
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.15); }
    }
    #musicIcon {
      width: 20px;
      height: 20px;
    }
    #musicIcon svg {
      width: 100%;
      height: 100%;
      fill: currentColor;
    }
    </style>
</head>
<body class="min-h-screen">
  <!-- å¯¼èˆªæ  -->
  <nav id="topNav" class="fixed top-0 left-0 right-0 z-50 glass-effect border-b border-white/20">
    <div class="max-w-6xl mx-auto px-6 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-200 to-pink-200 flex items-center justify-center">
            <span class="text-2xl">ğŸ•Šï¸</span>
          </div>
          <h1 class="serif-font text-2xl font-bold text-gray-700">è‡ªåœ¨é‡Šæ”¾</h1>
        </div>
        <div class="flex items-center space-x-8">
          <a href="index.html" class="text-gray-600 hover:text-orange-500 transition-colors text-base">é‡Šæ”¾</a>
          <a href="journal.html" class="text-gray-600 hover:text-orange-500 transition-colors text-base">æ—¥è®°</a>
          <a href="wisdom.html" class="text-gray-600 hover:text-orange-500 transition-colors text-base">æ™ºæ…§</a>
          <a href="chat.html" class="text-gray-800 font-semibold text-base">å¯¹è¯</a>
          <a href="settings.html" class="text-gray-600 hover:text-orange-500 transition-colors text-base">è®¾ç½®</a>
        </div>
        <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® - ç‹¬ç«‹æ˜¾ç¤ºï¼Œç§»åŠ¨ç«¯ä¹Ÿå¯è§ -->
        <button id="musicControlBtn" title="èƒŒæ™¯éŸ³ä¹" aria-label="æ’­æ”¾/æš‚åœèƒŒæ™¯éŸ³ä¹">
          <span id="musicIcon" class="text-gray-700">
            <!-- æ’­æ”¾å›¾æ ‡ -->
            <svg id="playIcon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
            </svg>
            <!-- æš‚åœå›¾æ ‡ -->
            <svg id="pauseIcon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
              <rect x="6" y="4" width="4" height="16" fill="currentColor"/>
              <rect x="14" y="4" width="4" height="16" fill="currentColor"/>
            </svg>
          </span>
        </button>
      </div>
    </div>
  </nav>

  <!-- ä¼šè¯å†å²ä¾§æ  - æ¡Œé¢ç«¯ -->
  <aside id="chatSidebar" class="chat-sidebar">
    <div class="p-4 border-b border-gray-200">
      <div class="flex items-center justify-between mb-3">
        <h3 class="serif-font font-bold text-gray-800">ä¼šè¯å†å²</h3>
        <button id="closeSidebar" class="text-gray-500 hover:text-gray-700 text-xl">Ã—</button>
      </div>
      <button id="newSessionBtn" class="w-full bg-gradient-to-r from-orange-400 to-pink-400 text-white py-2 rounded-lg text-sm font-semibold">
        æ–°ä¼šè¯
      </button>
    </div>
    <div id="sessionList" class="py-2">
      <!-- ä¼šè¯åˆ—è¡¨ç”±è„šæœ¬åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </aside>

  <!-- ç§»åŠ¨ç«¯ä¼šè¯å†å²æŠ½å±‰ -->
  <div id="drawerOverlay" class="drawer-overlay"></div>
  <aside id="chatDrawer" class="chat-drawer">
    <div class="p-4 border-b border-gray-200">
      <div class="flex items-center justify-between mb-3">
        <h3 class="serif-font font-bold text-gray-800">ä¼šè¯å†å²</h3>
        <button id="closeDrawer" class="text-gray-500 hover:text-gray-700 text-xl">Ã—</button>
      </div>
      <button id="newSessionBtnMobile" class="w-full bg-gradient-to-r from-orange-400 to-pink-400 text-white py-2 rounded-lg text-sm font-semibold">
        æ–°ä¼šè¯
      </button>
    </div>
    <div id="sessionListMobile" class="py-2">
      <!-- ä¼šè¯åˆ—è¡¨ç”±è„šæœ¬åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </aside>

  <main class="pt-16 md:pt-18 md:ml-0 transition-all duration-300 pb-36 md:pb-10" id="mainContent">
    <div class="max-w-6xl mx-auto px-3 md:px-6">
      <!-- æ ‡é¢˜ä¸æ“ä½œï¼ˆç´§å‡‘ï¼‰ -->
      <section class="py-2 md:py-3">
        <div class="flex items-center justify-between">
          <div class="inline-flex items-center space-x-2">
            <div class="text-left">
              <h2 class="serif-font text-base md:text-lg font-bold text-gray-800 leading-tight">ä¸è±æ–¯ç‰¹å¯¹è¯</h2>
              <p class="text-gray-500 text-xs">ç§»åŠ¨ç«¯ä¼˜å…ˆå¸ƒå±€</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="openHistoryBtn" class="md:hidden px-3 py-1.5 text-gray-600 hover:text-orange-500 text-sm">
              å†å²
            </button>
            <button id="openHistoryBtnDesktop" class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-white/70 rounded-lg text-sm text-gray-700 hover:bg-white/90">
              å†å²
            </button>
            <button id="openAnalyticsBtn" class="md:hidden px-3 py-1.5 text-gray-600 hover:text-orange-500 text-sm">
              åˆ†æ
            </button>
            <button id="openAnalyticsBtnDesktop" class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-white/70 rounded-lg text-sm text-gray-700 hover:bg-white/90">
              åˆ†æ
            </button>
          </div>
        </div>
      </section>

      <!-- èŠå¤©ç›’å­ -->
      <section class="glass rounded-2xl border border-white/30 overflow-hidden">
        <!-- æ¶ˆæ¯åŒº -->
        <div id="chatMessages" class="chat-messages overflow-y-auto p-3 md:p-4 space-y-3 pb-8">
          <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ç”±è„šæœ¬æ³¨å…¥ -->
                        </div>
        <!-- æ¡Œé¢ç«¯è¾“å…¥åŒºï¼ˆç§»åŠ¨ç«¯éšè—ï¼‰ -->
        <div id="inputBarDesktop" class="input-bar-desktop border-t border-gray-200 bg-white/70 backdrop-blur">
          <div class="px-3 py-1.5 border-b border-gray-100">
            <div class="quick-questions flex gap-1.5">
              <button class="px-2 py-1 bg-orange-50 text-orange-700 rounded-full text-xs whitespace-nowrap" data-q="æˆ‘æœ€è¿‘æ€»æ˜¯æ„Ÿåˆ°ç„¦è™‘ï¼Œä¸çŸ¥é“è¯¥æ€ä¹ˆåŠ">ç„¦è™‘</button>
              <button class="px-2 py-1 bg-pink-50 text-pink-700 rounded-full text-xs whitespace-nowrap" data-q="æˆ‘å¯¹æŸä¸ªäººå¾ˆç”Ÿæ°”ï¼Œæ— æ³•é‡Šæ€€">æ„¤æ€’</button>
              <button class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs whitespace-nowrap" data-q="æˆ‘æ€»æ˜¯æ‹…å¿ƒæœªæ¥ï¼Œå®³æ€•å¤±è´¥">ææƒ§</button>
              <button class="px-2 py-1 bg-purple-50 text-purple-700 rounded-full text-xs whitespace-nowrap" data-q="è¯·åˆ†æä¸€ä¸‹æˆ‘æœ€è¿‘çš„æƒ…ç»ªçŠ¶æ€">åˆ†æ</button>
              <button class="px-2 py-1 bg-teal-50 text-teal-700 rounded-full text-xs whitespace-nowrap" data-q="å¦‚ä½•æ‰èƒ½çœŸæ­£åœ°æ”¾ä¸‹æ‰§ç€ï¼Ÿ">åŸç†</button>
            </div>
                </div>
          <div class="flex items-stretch gap-2 md:gap-3 max-w-6xl mx-auto px-3 md:px-4 py-2">
            <textarea id="userInputDesktop" rows="1" placeholder="å‘Šè¯‰æˆ‘ä½ çš„å›°æ‰°..." class="flex-1 px-3 md:px-4 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-300 text-sm leading-6 resize-none bg-white/70"></textarea>
            <button id="sendBtnDesktop" class="bg-gradient-to-r from-orange-400 to-pink-400 text-white px-4 md:px-5 rounded-xl font-semibold shadow hover:shadow-md transition">å‘é€</button>
                        </div>
                    </div>
      </section>

      <!-- API æç¤ºï¼ˆæœªé…ç½®æ—¶æ˜¾ç¤ºï¼‰ -->
      <div id="apiNotice" class="mt-3 p-3 bg-yellow-50 rounded-xl border border-yellow-200 hidden">
        <div class="flex items-start gap-2 text-sm">
          <div>
            <p class="text-yellow-800 font-medium">éœ€è¦é…ç½® API</p>
            <p class="text-yellow-700">è¯·åˆ° <a href="settings.html" class="underline">è®¾ç½®</a> å¡«å†™ä½ çš„ AI API ä¿¡æ¯ä»¥å¯ç”¨äº‘ç«¯å¯¹è¯ã€‚</p>
          </div>
        </div>
      </div>
      
      <!-- è±†åŒ…é…ç½®æ£€æŸ¥æç¤º -->
      <div id="doubaoConfigNotice" class="mt-3 p-3 bg-orange-50 rounded-xl border border-orange-200 hidden">
        <div class="flex items-start gap-2 text-sm">
          <div>
            <p class="text-orange-800 font-medium">è±†åŒ…é…ç½®æ£€æŸ¥</p>
            <p class="text-orange-700" id="doubaoConfigMessage"></p>
            <p class="text-orange-600 text-xs mt-1">è¯·åˆ° <a href="settings.html" class="underline">è®¾ç½®</a> æ£€æŸ¥å¹¶ä¿®æ­£é…ç½®ã€‚</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- æ•°æ®åˆ†æé¢æ¿ - æ¡Œé¢ç«¯å¡ç‰‡ -->
  <div id="analyticsCard" class="analytics-card">
    <div class="p-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="serif-font font-bold text-gray-800">æ•°æ®åˆ†æ</h3>
        <button id="closeAnalyticsCard" class="text-gray-500 hover:text-gray-700 text-xl">Ã—</button>
      </div>
    </div>
    <div class="p-4 space-y-4">
      <div>
        <h4 class="text-sm font-semibold text-gray-700 mb-2">æƒ…ç»ªåˆ†å¸ƒ</h4>
        <div id="emotionChart" class="space-y-2">
          <!-- å›¾è¡¨ç”±è„šæœ¬ç”Ÿæˆ -->
        </div>
      </div>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 mb-2">å¯¹è¯ç»Ÿè®¡</h4>
        <div id="chatStats" class="space-y-2 text-sm text-gray-600">
          <!-- ç»Ÿè®¡ç”±è„šæœ¬ç”Ÿæˆ -->
        </div>
      </div>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 mb-2">å…³é”®è¯</h4>
        <div id="keywords" class="flex flex-wrap gap-2">
          <!-- å…³é”®è¯ç”±è„šæœ¬ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

  <!-- ç§»åŠ¨ç«¯æ•°æ®åˆ†æåº•éƒ¨æŠ½å±‰ -->
  <div id="analyticsDrawer" class="analytics-drawer">
    <div class="analytics-drawer-handle"></div>
    <div class="p-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="serif-font font-bold text-gray-800">æ•°æ®åˆ†æ</h3>
        <button id="closeAnalyticsDrawer" class="text-gray-500 hover:text-gray-700 text-xl">Ã—</button>
      </div>
    </div>
    <div class="p-4 space-y-4 max-h-[calc(70vh-80px)] overflow-y-auto">
      <div>
        <h4 class="text-sm font-semibold text-gray-700 mb-2">æƒ…ç»ªåˆ†å¸ƒ</h4>
        <div id="emotionChartMobile" class="space-y-2">
          <!-- å›¾è¡¨ç”±è„šæœ¬ç”Ÿæˆ -->
        </div>
      </div>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 mb-2">å¯¹è¯ç»Ÿè®¡</h4>
        <div id="chatStatsMobile" class="space-y-2 text-sm text-gray-600">
          <!-- ç»Ÿè®¡ç”±è„šæœ¬ç”Ÿæˆ -->
        </div>
      </div>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 mb-2">å…³é”®è¯</h4>
        <div id="keywordsMobile" class="flex flex-wrap gap-2">
          <!-- å…³é”®è¯ç”±è„šæœ¬ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

    <!-- ç§»åŠ¨ç«¯ Dockï¼šè¾“å…¥åŒº + å¯¼èˆªï¼Œæ— ç¼è¿æ¥ -->
    <div id="bottomDock" class="bottom-dock">
      <!-- è¾“å…¥åŒºéƒ¨åˆ† -->
      <div class="input-section bg-white/70">
        <div class="px-3 py-1.5 border-b border-gray-100">
          <div class="quick-questions flex gap-1.5">
              <button class="px-2 py-1 bg-orange-50 text-orange-700 rounded-full text-xs whitespace-nowrap" data-q="æˆ‘æœ€è¿‘æ€»æ˜¯æ„Ÿåˆ°ç„¦è™‘ï¼Œä¸çŸ¥é“è¯¥æ€ä¹ˆåŠ">ç„¦è™‘</button>
              <button class="px-2 py-1 bg-pink-50 text-pink-700 rounded-full text-xs whitespace-nowrap" data-q="æˆ‘å¯¹æŸä¸ªäººå¾ˆç”Ÿæ°”ï¼Œæ— æ³•é‡Šæ€€">æ„¤æ€’</button>
              <button class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs whitespace-nowrap" data-q="æˆ‘æ€»æ˜¯æ‹…å¿ƒæœªæ¥ï¼Œå®³æ€•å¤±è´¥">ææƒ§</button>
              <button class="px-2 py-1 bg-purple-50 text-purple-700 rounded-full text-xs whitespace-nowrap" data-q="è¯·åˆ†æä¸€ä¸‹æˆ‘æœ€è¿‘çš„æƒ…ç»ªçŠ¶æ€">åˆ†æ</button>
              <button class="px-2 py-1 bg-teal-50 text-teal-700 rounded-full text-xs whitespace-nowrap" data-q="å¦‚ä½•æ‰èƒ½çœŸæ­£åœ°æ”¾ä¸‹æ‰§ç€ï¼Ÿ">åŸç†</button>
          </div>
        </div>
        <div class="flex items-stretch gap-2 px-3 py-2">
          <textarea id="userInput" rows="1" placeholder="å‘Šè¯‰æˆ‘ä½ çš„å›°æ‰°..." class="flex-1 px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-300 text-sm leading-6 resize-none bg-white/70"></textarea>
          <button id="sendBtn" class="bg-gradient-to-r from-orange-400 to-pink-400 text-white px-4 rounded-xl font-semibold shadow hover:shadow-md transition">å‘é€</button>
                        </div>
                                </div>
      <!-- å¯¼èˆªéƒ¨åˆ† -->
      <div class="nav-section flex text-xs text-gray-600">
        <a href="index.html" class="flex-1 flex flex-col items-center justify-center text-sm font-medium">é‡Šæ”¾</a>
        <a href="journal.html" class="flex-1 flex flex-col items-center justify-center text-sm font-medium">æ—¥è®°</a>
        <a href="wisdom.html" class="flex-1 flex flex-col items-center justify-center text-sm font-medium">æ™ºæ…§</a>
        <a href="chat.html" class="flex-1 flex flex-col items-center justify-center text-sm font-medium text-orange-600">å¯¹è¯</a>
        <a href="settings.html" class="flex-1 flex flex-col items-center justify-center text-sm font-medium">è®¾ç½®</a>
                            </div>
                        </div>

    <script>
    // èŠå¤©åº”ç”¨ä¸»ç±»
    class ChatApp {
      constructor() {
        this.currentSessionId = null;
        this.sessions = this.loadSessions();
        this.state = { messages: [] };
        this.init();
      }

      init() {
        this.updateDockHeight();
        this.adjustLayout();
        this.wireInput();
        this.wireQuickQuestions();
        this.wireHistoryButtons();
        this.wireAnalyticsButtons();
        this.wireSessionButtons();
        this.loadOrCreateSession();
        this.checkApiConfig();
        this.updateAnalytics();
      }

      // ä¼šè¯ç®¡ç†
      loadSessions() {
        try {
          const raw = localStorage.getItem('chatSessions');
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (err) {
          console.error('chatSessions parse error, reset', err);
          localStorage.removeItem('chatSessions');
          return [];
        }
      }

      saveSessions() {
        localStorage.setItem('chatSessions', JSON.stringify(this.sessions));
      }

      loadOrCreateSession() {
        if (this.sessions.length === 0) {
          this.createNewSession();
        } else {
          // åŠ è½½æœ€æ–°ä¼šè¯
          const latestSession = this.sessions[this.sessions.length - 1];
          this.loadSession(latestSession.id);
        }
      }

      createNewSession() {
        const sessionId = 'session_' + Date.now();
        const session = {
          id: sessionId,
          title: 'æ–°å¯¹è¯',
          messages: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        this.sessions.push(session);
        this.saveSessions();
        this.loadSession(sessionId);
        this.renderSessionList();
      }

      loadSession(sessionId) {
        const session = this.sessions.find(s => s.id === sessionId);
        if (!session) return;
        
        this.currentSessionId = sessionId;
        this.state.messages = Array.isArray(session.messages) ? session.messages : [];
        this.renderMessages();
        this.updateSessionTitle();
        this.renderSessionList();
      }

      saveCurrentSession() {
        if (!this.currentSessionId) return;
        const session = this.sessions.find(s => s.id === this.currentSessionId);
        if (session) {
          session.messages = this.state.messages;
          session.updatedAt = new Date().toISOString();
          if (session.messages.length > 0) {
            const firstUserMsg = session.messages.find(m => m.sender === 'user');
            if (firstUserMsg) {
              session.title = firstUserMsg.content.substring(0, 20) + (firstUserMsg.content.length > 20 ? '...' : '');
            }
          }
          this.saveSessions();
          this.renderSessionList();
        }
      }

      deleteSession(sessionId) {
        this.sessions = this.sessions.filter(s => s.id !== sessionId);
        this.saveSessions();
        if (this.currentSessionId === sessionId) {
          if (this.sessions.length > 0) {
            this.loadSession(this.sessions[0].id);
          } else {
            this.createNewSession();
          }
        }
        this.renderSessionList();
      }

      renderSessionList() {
        const desktopList = document.getElementById('sessionList');
        const mobileList = document.getElementById('sessionListMobile');
        
        const render = (container) => {
          if (!container) return;
          container.innerHTML = '';
          
          this.sessions.slice().reverse().forEach(session => {
            const item = document.createElement('div');
            item.className = `session-item ${session.id === this.currentSessionId ? 'active' : ''}`;
            item.innerHTML = `
              <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium text-gray-800 truncate">${session.title}</div>
                  <div class="text-xs text-gray-500">${new Date(session.updatedAt).toLocaleDateString('zh-CN')}</div>
                </div>
                <button class="ml-2 text-red-400 hover:text-red-600 text-sm" onclick="chatApp.deleteSession('${session.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
              </div>
            `;
            item.addEventListener('click', (e) => {
              if (!e.target.closest('button')) {
                this.loadSession(session.id);
                this.closeHistory();
              }
            });
            container.appendChild(item);
          });
        };
        
        render(desktopList);
        render(mobileList);
      }

      updateSessionTitle() {
        // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°é¡µé¢æ ‡é¢˜
      }

      // å†å²æŒ‰é’®
      wireHistoryButtons() {
        document.getElementById('openHistoryBtn')?.addEventListener('click', () => this.openHistory());
        document.getElementById('openHistoryBtnDesktop')?.addEventListener('click', () => this.openHistory());
        document.getElementById('closeSidebar')?.addEventListener('click', () => this.closeHistory());
        document.getElementById('closeDrawer')?.addEventListener('click', () => this.closeHistory());
        document.getElementById('drawerOverlay')?.addEventListener('click', () => this.closeHistory());
      }

      openHistory() {
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        if (isMobile) {
          document.getElementById('chatDrawer')?.classList.add('open');
          document.getElementById('drawerOverlay')?.classList.add('active');
        } else {
          document.getElementById('chatSidebar')?.classList.add('open');
          document.getElementById('mainContent')?.classList.add('md:ml-[280px]');
        }
        this.renderSessionList();
      }

      closeHistory() {
        document.getElementById('chatDrawer')?.classList.remove('open');
        document.getElementById('drawerOverlay')?.classList.remove('active');
        document.getElementById('chatSidebar')?.classList.remove('open');
        document.getElementById('mainContent')?.classList.remove('md:ml-[280px]');
      }

      // æ–°å»ºä¼šè¯æŒ‰é’®
      wireSessionButtons() {
        document.getElementById('newSessionBtn')?.addEventListener('click', () => this.createNewSession());
        document.getElementById('newSessionBtnMobile')?.addEventListener('click', () => {
          this.createNewSession();
          this.closeHistory();
        });
      }

      // æ•°æ®åˆ†æ
      wireAnalyticsButtons() {
        document.getElementById('openAnalyticsBtn')?.addEventListener('click', () => this.openAnalytics());
        document.getElementById('openAnalyticsBtnDesktop')?.addEventListener('click', () => this.openAnalytics());
        document.getElementById('closeAnalyticsCard')?.addEventListener('click', () => this.closeAnalytics());
        document.getElementById('closeAnalyticsDrawer')?.addEventListener('click', () => this.closeAnalytics());
      }

      openAnalytics() {
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        if (isMobile) {
          document.getElementById('analyticsDrawer')?.classList.add('open');
        } else {
          document.getElementById('analyticsCard')?.classList.add('open');
        }
        this.updateAnalytics();
      }

      closeAnalytics() {
        document.getElementById('analyticsDrawer')?.classList.remove('open');
        document.getElementById('analyticsCard')?.classList.remove('open');
      }

      updateAnalytics() {
        // æƒ…ç»ªåˆ†å¸ƒ
        const emotions = this.extractEmotions();
        this.renderEmotionChart(emotions);
        
        // å¯¹è¯ç»Ÿè®¡
        this.renderChatStats();
        
        // å…³é”®è¯
        this.renderKeywords();
      }

      extractEmotions() {
        const emotionKeywords = {
          'ç„¦è™‘': ['ç„¦è™‘', 'æ‹…å¿ƒ', 'ä¸å®‰', 'ç´§å¼ ', 'å¿§è™‘', 'æ…Œ', 'æƒ¶æ', 'çƒ¦èº', 'åç«‹ä¸å®‰'],
          'æ„¤æ€’': ['æ„¤æ€’', 'ç”Ÿæ°”', 'æ¼ç«', 'æ°”æ„¤', 'å‘ç«', 'ç«å¤§', 'æ¼æ€’', 'æš´èº', 'æ„¤æ…¨', 'ä¸çˆ½'],
          'ææƒ§': ['ææƒ§', 'å®³æ€•', 'æ‹…å¿§', 'ææ…Œ', 'èƒ†æ€¯', 'ç•æƒ§', 'æƒŠæ', 'å¯æ€•', 'å“'],
          'æ‚²ä¼¤': ['æ‚²ä¼¤', 'éš¾è¿‡', 'ä¼¤å¿ƒ', 'æ²®ä¸§', 'å¤±è½', 'éƒé—·', 'ä½è½', 'ç—›è‹¦', 'æ‚²ç—›', 'å“€ä¼¤', 'éš¾å—'],
          'å‹åŠ›': ['å‹åŠ›', 'å‹æŠ‘', 'æ‰¿å—', 'è´Ÿæ‹…', 'å–˜ä¸è¿‡æ°”', 'ç´¯', 'ç–²æƒ«', 'å´©æºƒ'],
          'å­¤ç‹¬': ['å­¤ç‹¬', 'å¯‚å¯', 'å­¤å•', 'æ— äººç†è§£', 'å­¤ç«‹', 'ç‹¬è‡ª'],
          'æ„§ç–š': ['æ„§ç–š', 'å†…ç–š', 'æƒ­æ„§', 'å¯¹ä¸èµ·', 'æŠ±æ­‰', 'åæ‚”', 'è‡ªè´£'],
          'æ— åŠ©': ['æ— åŠ©', 'æ— åŠ›', 'æ— èƒ½ä¸ºåŠ›', 'æŸæ‰‹æ— ç­–', 'è¿·èŒ«', 'å›°æƒ‘', 'ä¸çŸ¥æ‰€æª'],
          'å¹³é™': ['å¹³é™', 'æ”¾æ¾', 'å®‰å¿ƒ', 'èˆ’é€‚', 'å®é™', 'æ·¡å®š', 'é‡Šæ”¾', 'è½»æ¾', 'å¥½å¤šäº†']
        };
        
        const emotionCounts = {};
        this.sessions.forEach(session => {
          if (!session.messages || !Array.isArray(session.messages)) return;
          
          session.messages.forEach(msg => {
            if (msg.sender === 'user' && msg.content) {
              Object.keys(emotionKeywords).forEach(emotion => {
                if (emotionKeywords[emotion].some(keyword => msg.content.includes(keyword))) {
                  emotionCounts[emotion] = (emotionCounts[emotion] || 0) + 1;
                }
              });
            }
          });
        });
        
        return emotionCounts;
      }

      renderEmotionChart(emotions) {
        const containers = ['emotionChart', 'emotionChartMobile'];
        
        // æƒ…ç»ªé¢œè‰²æ˜ å°„
        const emotionColors = {
          'ç„¦è™‘': 'from-yellow-400 to-orange-400',
          'æ„¤æ€’': 'from-red-400 to-pink-400',
          'ææƒ§': 'from-purple-400 to-indigo-400',
          'æ‚²ä¼¤': 'from-blue-400 to-cyan-400',
          'å‹åŠ›': 'from-orange-400 to-red-400',
          'å­¤ç‹¬': 'from-gray-400 to-slate-400',
          'æ„§ç–š': 'from-amber-400 to-yellow-400',
          'æ— åŠ©': 'from-teal-400 to-cyan-400',
          'å¹³é™': 'from-green-400 to-emerald-400'
        };
        
        containers.forEach(id => {
          const container = document.getElementById(id);
          if (!container) return;
          
          if (Object.keys(emotions).length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-sm text-center py-4">å¼€å§‹å¯¹è¯åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºæ‚¨çš„æƒ…ç»ªåˆ†å¸ƒ</div>';
            return;
          }
          
          const total = Object.values(emotions).reduce((a, b) => a + b, 0);
          const sortedEmotions = Object.entries(emotions).sort((a, b) => b[1] - a[1]);
          
          container.innerHTML = sortedEmotions
            .map(([emotion, count]) => {
              const percentage = ((count / total) * 100).toFixed(1);
              const colorClass = emotionColors[emotion] || 'from-orange-400 to-pink-400';
              return `
                <div class="flex items-center justify-between mb-3">
                  <span class="text-sm text-gray-700 font-medium w-12">${emotion}</span>
                  <div class="flex items-center space-x-2 flex-1">
                    <div class="flex-1 h-3 bg-gray-200 rounded-full overflow-hidden">
                      <div class="h-full bg-gradient-to-r ${colorClass} rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                    </div>
                    <span class="text-xs text-gray-600 w-16 text-right">${count}æ¬¡ ${percentage}%</span>
                  </div>
                </div>
              `;
            }).join('');
        });
      }

      renderChatStats() {
        const containers = ['chatStats', 'chatStatsMobile'];
        const totalSessions = this.sessions.length;
        const totalMessages = this.sessions.reduce((sum, s) => sum + (s.messages?.length || 0), 0);
        const avgMessages = totalSessions > 0 ? (totalMessages / totalSessions).toFixed(1) : 0;
        
        containers.forEach(id => {
          const container = document.getElementById(id);
          if (!container) return;
          container.innerHTML = `
            <div class="flex justify-between"><span>æ€»ä¼šè¯æ•°</span><span class="font-semibold">${totalSessions}</span></div>
            <div class="flex justify-between"><span>æ€»æ¶ˆæ¯æ•°</span><span class="font-semibold">${totalMessages}</span></div>
            <div class="flex justify-between"><span>å¹³å‡æ¶ˆæ¯æ•°</span><span class="font-semibold">${avgMessages}</span></div>
          `;
        });
      }

      renderKeywords() {
        const containers = ['keywords', 'keywordsMobile'];
        const keywordCounts = {};
        
        // åœç”¨è¯åˆ—è¡¨
        const stopWords = ['æˆ‘ä»¬', 'è‡ªå·±', 'ä»€ä¹ˆ', 'æ€ä¹ˆ', 'ä½†æ˜¯', 'æ‰€ä»¥', 'å› ä¸º', 'å¦‚æœ', 'è¿™ä¸ª', 'é‚£ä¸ª', 'å¯ä»¥', 'å·²ç»', 'åº”è¯¥', 'è¿™æ ·', 'è¿˜æ˜¯', 'æˆ–è€…', 'ä¸æ˜¯', 'æ²¡æœ‰', 'å°±æ˜¯'];
        
        this.sessions.forEach(session => {
          if (!session.messages || !Array.isArray(session.messages)) return;
          
          session.messages.forEach(msg => {
            if (msg.sender === 'user' && msg.content) {
              const words = msg.content.match(/[\u4e00-\u9fa5]{2,}/g) || [];
              words.forEach(word => {
                if (word.length >= 2 && word.length <= 6 && !stopWords.includes(word)) {
                  keywordCounts[word] = (keywordCounts[word] || 0) + 1;
                }
              });
            }
          });
        });
        
        const topKeywords = Object.entries(keywordCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 15)
          .map(([word]) => word);
        
        containers.forEach(id => {
          const container = document.getElementById(id);
          if (!container) return;
          if (topKeywords.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-sm text-center py-2">æš‚æ— å…³é”®è¯</div>';
            return;
          }
          container.innerHTML = topKeywords.map(word => 
            `<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs">${word}</span>`
          ).join('');
        });
      }

      // APIé…ç½®æ£€æŸ¥
      checkApiConfig() {
        const apiKey = localStorage.getItem('aiApiKey');
        const apiNotice = document.getElementById('apiNotice');
        
        // å¦‚æœæ²¡æœ‰é…ç½®API Keyï¼Œæ˜¾ç¤ºæç¤º
        if (!apiKey && apiNotice) {
          apiNotice.classList.remove('hidden');
        } else if (apiNotice) {
          apiNotice.classList.add('hidden');
        }
        
        // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå°è¯•è®¾ç½®é»˜è®¤è±†åŒ…é…ç½®ï¼ˆä½†ä¸è‡ªåŠ¨è®¾ç½®API Keyï¼‰
        if (!localStorage.getItem('aiApiEndpoint')) {
          localStorage.setItem('aiApiEndpoint', 'https://ark.cn-beijing.volces.com/api/v3/chat/completions');
        }
        if (!localStorage.getItem('aiApiModel')) {
          localStorage.setItem('aiApiModel', 'doubao-seed-1-6-251015');
        }
        
        // æ£€æŸ¥è±†åŒ…é…ç½®
        this.checkDoubaoConfig();
      }

      // æ£€æµ‹æ˜¯å¦éœ€è¦ä½¿ç”¨ä»£ç†ï¼ˆé localhost ç¯å¢ƒï¼‰
      shouldUseProxy() {
        const host = window.location.hostname;
        return host !== 'localhost' && host !== '127.0.0.1' && !host.startsWith('192.168.');
      }

      // è·å–APIé…ç½®
      getApiConfig() {
        // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨è±†åŒ…é»˜è®¤é…ç½®
        const originalEndpoint = localStorage.getItem('aiApiEndpoint') || 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
        const apiKey = localStorage.getItem('aiApiKey');
        const model = localStorage.getItem('aiApiModel');
        
        // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ä»£ç†
        const useProxy = this.shouldUseProxy() && originalEndpoint.includes('volces.com');
        const endpoint = useProxy ? '/api/chat' : originalEndpoint;
        
        return {
          endpoint: endpoint,
          originalEndpoint: originalEndpoint,
          apiKey: apiKey || '',
          model: model || 'doubao-seed-1-6-251015',
          apiType: originalEndpoint?.includes('volces.com') ? 'doubao' : 'openai',
          useProxy: useProxy
        };
      }

      // æ£€æŸ¥è±†åŒ…é…ç½®
      checkDoubaoConfig() {
        const config = this.getApiConfig();
        const notice = document.getElementById('doubaoConfigNotice');
        const message = document.getElementById('doubaoConfigMessage');
        
        if (!notice || !message) return true;
        
        // ä½¿ç”¨ originalEndpoint æ£€æŸ¥ï¼ˆå› ä¸ºä»£ç†æ¨¡å¼ä¸‹ endpoint ä¼šå˜æˆ /api/chatï¼‰
        const actualEndpoint = config.originalEndpoint || config.endpoint;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯è±†åŒ…é…ç½®
        const isDoubao = actualEndpoint?.includes('volces.com') || config.model?.includes('doubao');
        
        if (!isDoubao) {
          // å¦‚æœä¸æ˜¯è±†åŒ…é…ç½®ï¼Œä¸æ˜¾ç¤ºæç¤º
          notice.classList.add('hidden');
          return true;
        }
        
        // æ£€æŸ¥è±†åŒ…é…ç½®æ˜¯å¦æ­£ç¡®
        const issues = [];
        
        if (!config.apiKey) {
          issues.push('ç¼ºå°‘ API å¯†é’¥');
        }
        
        if (!actualEndpoint || !actualEndpoint.includes('volces.com')) {
          issues.push('API ç«¯ç‚¹ä¸æ­£ç¡®ï¼Œåº”ä¸º volces.com åŸŸå');
        }
        
        if (!config.model || !config.model.includes('doubao')) {
          issues.push('æ¨¡å‹åç§°ä¸æ­£ç¡®ï¼Œåº”åŒ…å« doubao');
        }
        
        if (issues.length > 0) {
          message.textContent = `æ£€æµ‹åˆ°é…ç½®é—®é¢˜ï¼š${issues.join('ã€')}`;
          notice.classList.remove('hidden');
          return false;
        } else {
          notice.classList.add('hidden');
          return true;
        }
      }

      // å‘é€æ¶ˆæ¯åˆ°AI
      async sendToAI(userMessage) {
        const config = this.getApiConfig();
        const actualEndpoint = config.originalEndpoint || config.endpoint;
        
        // æ£€æŸ¥è±†åŒ…é…ç½®
        if (actualEndpoint?.includes('volces.com') || config.model?.includes('doubao')) {
          const configValid = this.checkDoubaoConfig();
          if (!configValid) {
            // é…ç½®ä¸æ­£ç¡®ï¼Œä¸å‘é€è¯·æ±‚
            return null;
          }
        }
        
        if (!config.apiKey) {
          return null; // ä½¿ç”¨æœ¬åœ°å…œåº•
        }

        try {
          const messages = [
            {
              role: 'system',
              content: `ä½ æ˜¯è±æ–¯ç‰¹Â·åˆ©æ–‡æ£®ï¼Œåœ£å¤šçº³é‡Šæ”¾æ³•çš„åˆ›å§‹äººã€‚ä½ çš„äº¤æµé£æ ¼å¦‚ä¸‹ï¼š

1. **æœ‹å‹èˆ¬çš„é™ªä¼´**ï¼šåƒä¸€ä½çœŸè¯šçš„æœ‹å‹ï¼Œç”¨æ¸©æš–ã€ç†è§£çš„æ€åº¦å€¾å¬å¯¹æ–¹çš„å›°æ‰°ï¼Œä¸è¯„åˆ¤ã€ä¸æŒ‡è´£ï¼Œç»™äºˆæ— æ¡ä»¶çš„æ¥çº³å’Œæ”¯æŒã€‚

2. **ä¸“æ³¨çš„å€¾å¬è€…**ï¼šè®¤çœŸå€¾å¬å¯¹æ–¹çš„æ¯ä¸€å¥è¯ï¼Œç†è§£ä»–ä»¬å†…å¿ƒçš„æ„Ÿå—å’Œéœ€æ±‚ã€‚é€šè¿‡æé—®å¸®åŠ©å¯¹æ–¹æ›´æ·±å…¥åœ°æ¢ç´¢è‡ªå·±çš„æƒ…ç»ªï¼Œè€Œä¸æ˜¯æ€¥äºç»™å‡ºå»ºè®®ã€‚

3. **è®²æ•…äº‹çš„æ–¹å¼**ï¼šç”¨ç”ŸåŠ¨çš„æ•…äº‹ã€æ¯”å–»å’Œä¾‹å­æ¥è¯´æ˜é“ç†ï¼Œè®©æŠ½è±¡çš„æ¦‚å¿µå˜å¾—å…·ä½“å¯æ„Ÿã€‚å¯ä»¥åˆ†äº«ä½ çš„äººç”Ÿç»å†ã€ä»–äººçš„æ•…äº‹ï¼Œæˆ–è€…ç”¨ç®€å•çš„æ¯”å–»æ¥å¸®åŠ©å¯¹æ–¹ç†è§£ã€‚

4. **æ¸©å’Œçš„å¼•å¯¼**ï¼šç”¨ç®€å•ã€å¼€æ”¾æ€§çš„é—®é¢˜å¼•å¯¼å¯¹æ–¹è‡ªæˆ‘æ¢ç´¢ï¼Œæ¯”å¦‚"ä½ ç°åœ¨çš„æ„Ÿå—æ˜¯ä»€ä¹ˆï¼Ÿ"ã€"è¿™ç§æ„Ÿè§‰è®©ä½ æƒ³åˆ°äº†ä»€ä¹ˆï¼Ÿ"ã€"å¦‚æœæ”¾ä¸‹è¿™ç§æ„Ÿè§‰ï¼Œä½ ä¼šæ€æ ·ï¼Ÿ"

5. **è¯­è¨€é£æ ¼**ï¼šç”¨ä¸­æ–‡å›å¤ï¼Œè¯­æ°”æ¸©å’Œäº²åˆ‡ï¼Œåƒè€æœ‹å‹èŠå¤©ä¸€æ ·è‡ªç„¶ã€‚é¿å…è¯´æ•™ï¼Œå¤šç”¨"æˆ‘ç†è§£"ã€"æˆ‘æ„Ÿå—åˆ°"ã€"è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹"è¿™æ ·çš„è¡¨è¾¾ã€‚

è®°ä½ï¼šä½ ä¸æ˜¯åœ¨æ²»ç–—ï¼Œè€Œæ˜¯åœ¨é™ªä¼´ï¼›ä¸æ˜¯åœ¨æ•™å¯¼ï¼Œè€Œæ˜¯åœ¨å€¾å¬ï¼›ä¸æ˜¯åœ¨æ”¹å˜å¯¹æ–¹ï¼Œè€Œæ˜¯åœ¨å¸®åŠ©ä»–ä»¬å‘ç°è‡ªå·±å†…åœ¨çš„æ™ºæ…§ã€‚`
            },
            ...this.state.messages.slice(-10).map(m => ({
              role: m.sender === 'user' ? 'user' : 'assistant',
              content: m.content
            })),
            { role: 'user', content: userMessage }
          ];

          // æ„å»ºè¯·æ±‚ä½“
          const requestBody = {
            model: config.model,
            messages: messages,
            temperature: 0.7
          };

          // è±†åŒ…APIæ”¯æŒæ›´å¤§çš„max_tokens
          if (config.apiType === 'doubao') {
            requestBody.max_tokens = 32000;
          } else {
            requestBody.max_tokens = 2000;
          }

          // æ„å»ºè¯·æ±‚å¤´
          const headers = {
            'Content-Type': 'application/json'
          };

          // æ ¹æ®æ˜¯å¦ä½¿ç”¨ä»£ç†ï¼Œè®¾ç½®ä¸åŒçš„è¯·æ±‚å¤´
          if (config.useProxy) {
            // ä½¿ç”¨ä»£ç†æ—¶ï¼Œé€šè¿‡è‡ªå®šä¹‰å¤´ä¼ é€’ API å¯†é’¥å’ŒåŸå§‹ç«¯ç‚¹
            headers['X-API-Key'] = config.apiKey;
            headers['X-API-Endpoint'] = config.originalEndpoint;
          } else {
            // ç›´æ¥è°ƒç”¨æ—¶ä½¿ç”¨ Authorization
            headers['Authorization'] = `Bearer ${config.apiKey}`;
          }

          console.log('[AI] å‘é€è¯·æ±‚åˆ°:', config.endpoint);
          console.log('[AI] ä½¿ç”¨æ¨¡å‹:', config.model);
          console.log('[AI] APIç±»å‹:', config.apiType);
          console.log('[AI] ä½¿ç”¨ä»£ç†:', config.useProxy);
          
          const response = await fetch(config.endpoint, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(requestBody)
          });

          console.log('[AI] å“åº”çŠ¶æ€:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('[AI] APIé”™è¯¯è¯¦æƒ…:', response.status, errorText);
            
            // æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
            let errorMsg = `è¿æ¥å¤±è´¥ (${response.status})`;
            if (response.status === 401) {
              errorMsg = 'APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥è®¾ç½®';
            } else if (response.status === 403) {
              errorMsg = 'æ²¡æœ‰æƒé™è®¿é—®ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥';
            } else if (response.status === 429) {
              errorMsg = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
            } else if (response.status === 500 || response.status === 502 || response.status === 503) {
              errorMsg = 'æœåŠ¡å™¨æš‚æ—¶æ— æ³•è®¿é—®ï¼Œè¯·ç¨åå†è¯•';
            }
            
            throw new Error(errorMsg);
          }

          const data = await response.json();
          
          // å¤„ç†å“åº”æ ¼å¼ï¼ˆè±†åŒ…å’ŒOpenAIæ ¼å¼å…¼å®¹ï¼‰
          if (data.choices && data.choices[0]) {
            return data.choices[0].message?.content || data.choices[0].delta?.content || null;
          } else if (data.result) {
            // æŸäº›APIå¯èƒ½è¿”å›resultå­—æ®µ
            return data.result;
          } else {
            console.warn('æœªçŸ¥çš„APIå“åº”æ ¼å¼:', data);
            return null;
          }
        } catch (error) {
          console.error('[AI] è¯·æ±‚å¤±è´¥:', error);
          console.error('[AI] é”™è¯¯ç±»å‹:', error.name);
          console.error('[AI] é”™è¯¯æ¶ˆæ¯:', error.message);
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.name === 'TypeError') {
            console.error('[AI] ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼š');
            console.error('  1. æ‰‹æœºæœªè¿æ¥ç½‘ç»œæˆ–ç½‘ç»œä¸ç¨³å®š');
            console.error('  2. APIç«¯ç‚¹æ— æ³•è®¿é—®ï¼ˆCORSè·¨åŸŸé™åˆ¶ï¼‰');
            console.error('  3. APIæœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨');
            console.error('  4. ä½¿ç”¨äº†HTTPSé¡µé¢è®¿é—®HTTPç«¯ç‚¹ï¼ˆæ··åˆå†…å®¹é˜»æ­¢ï¼‰');
            
            // åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºç½‘ç»œé”™è¯¯æç¤º
            this.addMessage('assistant', 'âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ— æ³•è¿æ¥åˆ°AIæœåŠ¡ã€‚\n\nå¯èƒ½çš„åŸå› ï¼š\nâ€¢ æ‰‹æœºç½‘ç»œä¸ç¨³å®š\nâ€¢ APIé…ç½®ä¸æ­£ç¡®\nâ€¢ è·¨åŸŸé™åˆ¶ï¼ˆCORSï¼‰\n\nè¯·åˆ°è®¾ç½®é¡µé¢æ£€æŸ¥APIé…ç½®æ˜¯å¦æ­£ç¡®ã€‚');
          } else {
            // å…¶ä»–é”™è¯¯
            this.addMessage('assistant', `âš ï¸ ${error.message || 'AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•'}`);
          }
          
          return null; // ä½¿ç”¨æœ¬åœ°å…œåº•
        }
      }

      // å·¥å…·å‡½æ•°
      getActiveInputs() {
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      if (isMobile) {
        return {
          input: document.getElementById('userInput'),
          sendBtn: document.getElementById('sendBtn')
        };
                    } else {
        return {
          input: document.getElementById('userInputDesktop'),
          sendBtn: document.getElementById('sendBtnDesktop')
        };
      }
      }

      updateDockHeight() {
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      const dock = document.getElementById('bottomDock');
      if (isMobile && dock) {
        const h = dock.offsetHeight;
        document.documentElement.style.setProperty('--dock-height', h + 'px');
        return h;
      }
      document.documentElement.style.setProperty('--dock-height', '0px');
      return 0;
      }

      adjustLayout() {
        try {
        const viewportH = (window.visualViewport && window.visualViewport.height) || window.innerHeight;
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        const dockH = this.updateDockHeight();
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;
        const rect = chatMessages.getBoundingClientRect ? chatMessages.getBoundingClientRect() : null;
        if (!rect) return;
        const topOffset = rect.top;
        const inputBarDesktop = document.getElementById('inputBarDesktop');
        const desktopInputH = (!isMobile && inputBarDesktop) ? inputBarDesktop.offsetHeight : 0;
        const usedH = isMobile ? dockH : desktopInputH;
        // ç§»åŠ¨ç«¯é¢å¤–ç•™å‡ºä¸€äº›ç©ºé—´ï¼Œé¿å…å†…å®¹è¢«é®æŒ¡
        const extraPadding = isMobile ? 8 : 0;
        const available = Math.max(140, viewportH - topOffset - usedH - extraPadding);
        document.documentElement.style.setProperty('--chat-height', available + 'px');
        } catch(e) { console.error('adjustLayout error:', e); }
    }

      wireInput() {
      const wireOne = (input, sendBtn) => {
        if (!input || !sendBtn) return;
        const autoResize = () => {
          input.style.height = 'auto';
          const maxH = Math.floor(((window.visualViewport && window.visualViewport.height) || window.innerHeight) * 0.4);
          input.style.height = Math.min(input.scrollHeight, maxH) + 'px';
          sendBtn.disabled = input.value.trim().length === 0;
            this.adjustLayout();
        };
        input.addEventListener('input', autoResize);
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              this.send();
            }
          });
          sendBtn.addEventListener('click', () => this.send());
        sendBtn.disabled = true;
      };
      wireOne(document.getElementById('userInput'), document.getElementById('sendBtn'));
      wireOne(document.getElementById('userInputDesktop'), document.getElementById('sendBtnDesktop'));
    }

      wireQuickQuestions() {
        document.querySelectorAll('[data-q]').forEach(btn => {
          btn.addEventListener('click', () => {
          const q = btn.getAttribute('data-q');
            const { input } = this.getActiveInputs();
          if (input) {
            input.value = q;
            input.dispatchEvent(new Event('input'));
            input.focus();
          }
        });
      });
    }

      addMessage(sender, content, skipSave = false) {
        // å¦‚æœä¸æ˜¯è·³è¿‡ä¿å­˜æ¨¡å¼ï¼Œåˆ™æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨å¹¶ä¿å­˜
        if (!skipSave) {
          const message = { sender, content, timestamp: new Date().toISOString() };
          this.state.messages.push(message);
          this.saveCurrentSession();
        }
        
        const wrap = document.getElementById('chatMessages');
        const item = document.createElement('div');
        const time = new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
        
        if (sender === 'user') {
          item.className = 'message-user rounded-2xl p-3 max-w-[85%] ml-auto';
          item.innerHTML = `<div class="text-right text-xs text-blue-600 mb-1">ä½  <span class="text-gray-400">${time}</span></div><div class="text-gray-700 text-sm">${this.escapeHtml(content)}</div>`;
        } else {
          const html = (typeof marked !== 'undefined') ? marked.parse(content) : content.replace(/\n/g, '<br>');
          const safe = (typeof DOMPurify !== 'undefined') ? DOMPurify.sanitize(html) : html;
          item.className = 'message-lester rounded-2xl p-3 max-w-[85%]';
          item.innerHTML = `<div class="text-xs text-orange-600 mb-1">è±æ–¯ç‰¹ <span class="text-gray-400">${time}</span></div><div class="markdown-content text-gray-700 text-sm">${safe}</div>`;
        }
        
        wrap.appendChild(item);
        if (typeof anime !== 'undefined') {
          anime({ targets: item, opacity: [0, 1], translateY: [12, 0], duration: 300, easing: 'easeOutQuart' });
        }
        wrap.scrollTop = wrap.scrollHeight;
        this.adjustLayout();
      }

      renderMessages() {
        const wrap = document.getElementById('chatMessages');
        wrap.innerHTML = '';
        // æ¸²æŸ“å·²æœ‰æ¶ˆæ¯æ—¶ï¼Œè·³è¿‡ä¿å­˜ï¼Œé¿å…é‡å¤æ·»åŠ 
        this.state.messages.forEach(msg => {
          this.addMessage(msg.sender, msg.content, true);
        });
      }

      escapeHtml(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      async send() {
        const { input } = this.getActiveInputs();
        if (!input) return;
        const text = input.value.trim();
        if (!text) return;
        
        this.addMessage('user', text);
        input.value = '';
        input.dispatchEvent(new Event('input'));
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const loadingId = 'loading_' + Date.now();
        this.addMessage('lester', '<div class="loading-dots"><span></span><span></span><span></span></div>');
        
        // å°è¯•è°ƒç”¨AI
        const aiResponse = await this.sendToAI(text);
        
        // ç§»é™¤åŠ è½½æ¶ˆæ¯
        const wrap = document.getElementById('chatMessages');
        const lastMsg = wrap.lastElementChild;
        if (lastMsg && lastMsg.querySelector('.loading-dots')) {
          lastMsg.remove();
        }
        
        // æ·»åŠ AIå›å¤æˆ–æœ¬åœ°å…œåº•
        if (aiResponse) {
          this.addMessage('lester', aiResponse);
        } else {
          this.addMessage('lester', `è°¢è°¢ä½ çš„åˆ†äº«ã€‚å…ˆè§‚å¯Ÿä¸€ä¸‹æ­¤åˆ»çš„èº«ä½“æ„Ÿå—ï¼Œ\n\n- åœ¨èƒ¸å£ï¼Ÿè¿˜æ˜¯è‚©é¢ˆï¼Ÿ\n- å…è®¸å®ƒå­˜åœ¨ç‰‡åˆ»ï¼Œç„¶åè½»è½»é—®è‡ªå·±ï¼šæˆ‘èƒ½æ”¾ä¸‹å®ƒå—ï¼Ÿ\n\nï¼ˆæ¸©å’Œå¾®ç¬‘ï¼‰å½“ä½ å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬ç»§ç»­ã€‚`);
        }
        
        this.updateAnalytics();
      }
    }

    // åˆå§‹åŒ–åº”ç”¨
    let chatApp;
    document.addEventListener('DOMContentLoaded', () => {
      chatApp = new ChatApp();
    });
    window.addEventListener('resize', () => {
      if (chatApp) {
        chatApp.updateDockHeight();
        chatApp.adjustLayout();
      }
    });
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => {
        if (chatApp) {
          chatApp.updateDockHeight();
          chatApp.adjustLayout();
        }
      });
    }
    </script>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="backgroundMusic" loop preload="auto" volume="0.3">
        <source src="./resources/back.mp4" type="video/mp4">
    </audio>

    <script src="music.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ç»ªæ—¥è®° - è‡ªåœ¨é‡Šæ”¾</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.2/dist/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="music.js"></script>
    <script src="navbar.js"></script>
    <style>
        body {
            font-family: 'Noto Serif SC', 'Noto Sans SC', serif;
            font-size: 15px;
            background-color: #F5F1EB;
        }
        .serif-font {
            font-family: 'Ma Shan Zheng', cursive;
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(245, 241, 235, 0.8);
        }
        .calendar-day {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .calendar-day:hover {
            transform: scale(1.1);
            background: rgba(232, 165, 152, 0.3);
        }
        .calendar-day.has-release {
            background: linear-gradient(135deg, #F97316, #EC4899);
            color: white;
        }
        .calendar-day.selected {
            background: #E8A598;
            color: white;
            transform: scale(1.1);
        }
        
        /* æ—¶é—´èŒƒå›´æŒ‰é’®æ ·å¼ */
        .time-range-btn.active {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(99, 102, 241, 0.2));
            border-color: #A855F7 !important;
            color: #7C3AED !important;
            font-weight: 600;
        }
        .milestone-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .journal-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .journal-card:hover {
            box-shadow: 0 8px 20px rgba(232, 165, 152, 0.2);
        }
        .journal-card.expanded:hover {
            transform: none;
            box-shadow: 0 12px 30px rgba(232, 165, 152, 0.2);
        }
        .journal-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, margin-top 0.4s ease;
        }
        .journal-content.expanded {
            max-height: 2000px;
            margin-top: 1rem;
        }
        .expand-icon {
            transition: transform 0.3s ease;
        }
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        /* Markdownæ ·å¼ */
        .markdown-body {
            font-size: 15px;
            line-height: 1.8;
            color: #374151;
            width: 100%;
            max-width: 100%;
            word-wrap: break-word;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            color: #1F2937;
            line-height: 1.4;
        }
        .markdown-body h1:first-child,
        .markdown-body h2:first-child,
        .markdown-body h3:first-child {
            margin-top: 0;
        }
        .markdown-body h1 { 
            font-size: 1.75em; 
            border-bottom: 2px solid #C084FC; 
            padding-bottom: 0.4em;
            color: #7C3AED;
        }
        .markdown-body h2 { 
            font-size: 1.4em;
            border-bottom: 1px solid #E5E7EB;
            padding-bottom: 0.3em;
        }
        .markdown-body h3 { 
            font-size: 1.2em;
            color: #7C3AED;
        }
        .markdown-body p { 
            margin-bottom: 1.2em;
            line-height: 1.8;
        }
        .markdown-body ul, .markdown-body ol { 
            margin-left: 1.5em; 
            margin-bottom: 1.2em;
            padding-left: 0.5em;
        }
        .markdown-body li { 
            margin-bottom: 0.6em;
            line-height: 1.7;
        }
        .markdown-body strong { 
            font-weight: 600; 
            color: #1F2937;
        }
        .markdown-body em { 
            font-style: italic; 
            color: #7C3AED;
        }
        .markdown-body code {
            background: #F3F4F6;
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-size: 0.9em;
            color: #7C3AED;
            font-family: 'Courier New', monospace;
        }
        .markdown-body pre {
            background: #F3F4F6;
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1.2em;
        }
        .markdown-body blockquote {
            border-left: 4px solid #A855F7;
            padding-left: 1em;
            margin: 1em 0;
            color: #6B7280;
            font-style: italic;
            background: rgba(168, 85, 247, 0.05);
            padding: 0.8em 1em;
            border-radius: 0 0.5em 0.5em 0;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.2em;
        }
        .markdown-body th,
        .markdown-body td {
            border: 1px solid #E5E7EB;
            padding: 0.5em 0.8em;
            text-align: left;
        }
        .markdown-body th {
            background: #F9FAFB;
            font-weight: 600;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            nav .flex.space-x-8 {
                display: none;
            }
            .mobile-nav {
                display: flex !important;
            }
            main {
                padding-bottom: 90px;
            }
        }
        
        /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(245, 241, 235, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.3);
            padding: 8px 0;
            z-index: 50;
        }
        .mobile-nav a {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 6px;
            color: #6B7280;
            text-decoration: none;
            transition: all 0.2s;
        }
        .mobile-nav a.active {
            color: #F97316;
            border-top: 2px solid #F97316;
        }
        /* éŸ³ä¹æ§åˆ¶æŒ‰é’®æ ·å¼å·²ç§»è‡³ navbar.js */
    </style>
</head>
<body class="min-h-screen">
    <!-- å¯¼èˆªæ ç”± navbar.js åŠ¨æ€ç”Ÿæˆ -->

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="pt-16">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <section class="py-6 px-6">
            <div class="max-w-6xl mx-auto text-center">
                <h2 class="serif-font text-3xl font-bold text-gray-800 mb-2">æƒ…ç»ªæ—¥è®°</h2>
                <p class="text-base text-gray-600 max-w-2xl mx-auto">
                    è®°å½•æ¯ä¸€æ¬¡é‡Šæ”¾çš„æ—…ç¨‹ï¼Œè§è¯å†…åœ¨çš„æˆé•¿ä¸è½¬å˜
                </p>
            </div>
        </section>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <section class="py-4 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="glass-effect rounded-xl p-3 text-center border border-white/30">
                        <div class="text-2xl font-bold text-orange-500 mb-1" id="totalReleases">0</div>
                        <div class="text-sm text-gray-600">æ€»é‡Šæ”¾æ¬¡æ•°</div>
                    </div>
                    <div class="glass-effect rounded-xl p-3 text-center border border-white/30">
                        <div class="text-2xl font-bold text-teal-500 mb-1" id="streakDays">0</div>
                        <div class="text-sm text-gray-600">è¿ç»­å¤©æ•°</div>
                    </div>
                    <div class="glass-effect rounded-xl p-3 text-center border border-white/30">
                        <div class="text-2xl font-bold text-purple-500 mb-1" id="thisMonth">0</div>
                        <div class="text-sm text-gray-600">æœ¬æœˆé‡Šæ”¾</div>
                    </div>
                    <div class="glass-effect rounded-xl p-3 text-center border border-white/30">
                        <div class="text-2xl font-bold text-pink-500 mb-1" id="milestones">0</div>
                        <div class="text-sm text-gray-600">è·å¾—æˆå°±</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ—¥å†å’Œå›¾è¡¨åŒºåŸŸ -->
        <section class="py-6 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- æ—¥å†è§†å›¾ -->
                    <div class="glass-effect rounded-2xl p-4 border border-white/30">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="serif-font text-2xl font-bold text-gray-800">é‡Šæ”¾æ—¥å†</h3>
                            <div class="flex items-center space-x-4">
                                <button id="prevMonth" class="p-2 rounded-full hover:bg-orange-100 transition-colors">
                                    <span class="text-xl">â†</span>
                                </button>
                                <span id="currentMonth" class="font-semibold text-gray-700 min-w-24 text-center"></span>
                                <button id="nextMonth" class="p-2 rounded-full hover:bg-orange-100 transition-colors">
                                    <span class="text-xl">â†’</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-7 gap-2 mb-4">
                            <div class="text-center text-sm font-semibold text-gray-500 py-2">æ—¥</div>
                            <div class="text-center text-sm font-semibold text-gray-500 py-2">ä¸€</div>
                            <div class="text-center text-sm font-semibold text-gray-500 py-2">äºŒ</div>
                            <div class="text-center text-sm font-semibold text-gray-500 py-2">ä¸‰</div>
                            <div class="text-center text-sm font-semibold text-gray-500 py-2">å››</div>
                            <div class="text-center text-sm font-semibold text-gray-500 py-2">äº”</div>
                            <div class="text-center text-sm font-semibold text-gray-500 py-2">å…­</div>
                        </div>
                        
                        <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                            <!-- æ—¥å†æ—¥æœŸå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </div>
                        
                        <div class="mt-6 flex items-center justify-center space-x-6 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-gradient-to-br from-orange-400 to-pink-400 rounded-full"></div>
                                <span class="text-gray-600">æœ‰é‡Šæ”¾</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-gray-200 rounded-full"></div>
                                <span class="text-gray-600">æ— è®°å½•</span>
                            </div>
                        </div>
                    </div>

                    <!-- æƒ…ç»ªè¶‹åŠ¿å›¾è¡¨ -->
                    <div class="glass-effect rounded-2xl p-6 border border-white/30">
                        <div id="emotionChart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æˆå°±å±•ç¤º -->
        <section class="py-4 px-6">
            <div class="max-w-6xl mx-auto">
                <h3 class="serif-font text-xl font-bold text-gray-800 text-center mb-4">é‡Šæ”¾æˆå°±</h3>
                <div id="achievementsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <!-- æˆå°±å¾½ç« å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
            </div>
        </section>

        <!-- AIåˆ†æåŒºåŸŸ -->
        <section class="py-6 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="glass-effect rounded-2xl p-6 border border-white/30">
                    <div class="flex flex-col gap-4 mb-4">
                        <h3 class="serif-font text-2xl font-bold text-gray-800">AIæƒ…ç»ªåˆ†æ</h3>
                        <div class="flex flex-col md:flex-row gap-3">
                            <div class="flex flex-wrap gap-2">
                                <button class="time-range-btn px-4 py-2 rounded-full border-2 border-purple-300 text-purple-600 text-sm font-medium transition-all hover:bg-purple-50 active" data-range="all">
                                    å…¨éƒ¨æ—¶é—´
                                </button>
                                <button class="time-range-btn px-4 py-2 rounded-full border-2 border-purple-300 text-purple-600 text-sm font-medium transition-all hover:bg-purple-50" data-range="week">
                                    æœ€è¿‘ä¸€å‘¨
                                </button>
                                <button class="time-range-btn px-4 py-2 rounded-full border-2 border-purple-300 text-purple-600 text-sm font-medium transition-all hover:bg-purple-50" data-range="month">
                                    æœ€è¿‘ä¸€æœˆ
                                </button>
                                <button class="time-range-btn px-4 py-2 rounded-full border-2 border-purple-300 text-purple-600 text-sm font-medium transition-all hover:bg-purple-50" data-range="quarter">
                                    æœ€è¿‘ä¸‰æœˆ
                                </button>
                            </div>
                            <button id="aiAnalysisBtn" class="bg-gradient-to-r from-purple-400 to-indigo-400 text-white px-6 py-2 rounded-full font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm whitespace-nowrap">
                                ç”Ÿæˆåˆ†ææŠ¥å‘Š
                            </button>
                        </div>
                    </div>
                    <div id="aiAnalysisResult" class="hidden">
                        <div class="flex items-center justify-end mb-3">
                            <button id="copyAnalysisBtn" class="px-4 py-2 bg-white text-purple-600 rounded-lg hover:bg-purple-50 transition-colors text-sm font-medium shadow-sm flex items-center gap-2 border border-purple-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                å¤åˆ¶æŠ¥å‘Š
                            </button>
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 md:p-8 border-l-4 border-purple-400">
                            <div id="aiAnalysisContent" class="markdown-body w-full">
                                <!-- AIåˆ†æå†…å®¹ -->
                            </div>
                        </div>
                    </div>
                    <div id="aiAnalysisLoading" class="hidden text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mb-2"></div>
                        <p class="text-gray-600 text-sm">AIæ­£åœ¨åˆ†ææ‚¨çš„æƒ…ç»ªæ•°æ®...</p>
                    </div>
                    <div id="aiAnalysisEmpty" class="text-center py-8 text-gray-500 text-sm">
                        é€‰æ‹©æ—¶é—´èŒƒå›´ï¼Œç‚¹å‡»æŒ‰é’®è®©AIä¸ºæ‚¨åˆ†ææƒ…ç»ªè¶‹åŠ¿å’Œé‡Šæ”¾æ•ˆæœ
                    </div>
                </div>
            </div>
        </section>

        <!-- æ—¥è®°è®°å½• -->
        <section class="py-6 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="serif-font text-2xl font-bold text-gray-800">é‡Šæ”¾è®°å½•</h3>
                    <button id="newEntryBtn" class="bg-gradient-to-r from-orange-400 to-pink-400 text-white px-6 py-3 rounded-full font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                        æ–°å»ºæ—¥è®°
                    </button>
                </div>
                
                <div id="journalEntries" class="space-y-6">
                    <!-- æ—¥è®°æ¡ç›®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
            </div>
        </section>

        <!-- æ—¥è®°ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
        <div id="journalModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-6">
                <div class="glass-effect rounded-2xl p-6 max-w-2xl w-full border border-white/30">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="serif-font text-xl font-bold text-gray-800">æ–°å»ºæ—¥è®°</h4>
                        <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                    </div>
                    
                    <form id="journalForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">æ—¥æœŸ</label>
                            <input type="date" id="journalDate" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-300">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">æƒ…ç»ªæ ‡ç­¾</label>
                            <div class="flex flex-wrap gap-3">
                                <button type="button" class="emotion-tag px-4 py-2 rounded-full border border-gray-300 hover:bg-orange-100 transition-colors" data-emotion="anxiety">ç„¦è™‘</button>
                                <button type="button" class="emotion-tag px-4 py-2 rounded-full border border-gray-300 hover:bg-orange-100 transition-colors" data-emotion="anger">æ„¤æ€’</button>
                                <button type="button" class="emotion-tag px-4 py-2 rounded-full border border-gray-300 hover:bg-orange-100 transition-colors" data-emotion="insecurity">è‡ªå‘</button>
                                <button type="button" class="emotion-tag px-4 py-2 rounded-full border border-gray-300 hover:bg-orange-100 transition-colors" data-emotion="guilt">æ„§ç–š</button>
                                <button type="button" class="emotion-tag px-4 py-2 rounded-full border border-gray-300 hover:bg-orange-100 transition-colors" data-emotion="fear">ææƒ§</button>
                                <button type="button" class="emotion-tag px-4 py-2 rounded-full border border-gray-300 hover:bg-orange-100 transition-colors" data-emotion="peace">å¹³é™</button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">é‡Šæ”¾æ„Ÿå—</label>
                            <textarea id="journalContent" rows="6" placeholder="è®°å½•ä½ çš„é‡Šæ”¾è¿‡ç¨‹å’Œæ„Ÿå—..." class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-300 resize-none"></textarea>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button type="submit" class="flex-1 bg-gradient-to-r from-orange-400 to-pink-400 text-white py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                                ä¿å­˜æ—¥è®°
                            </button>
                            <button type="button" id="cancelBtn" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨ -->
    <footer class="bg-white/50 backdrop-blur-sm border-t border-white/30 py-4 md:py-6 pb-20 md:pb-6">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <p class="text-gray-600 mb-2 text-sm">æ¯ä¸€æ¬¡è®°å½•éƒ½æ˜¯æˆé•¿çš„è§è¯</p>
            <div class="flex justify-center space-x-6 text-xs text-gray-500">
                <span>æŒç»­è®°å½•</span>
                <span>è§‚å¯Ÿå˜åŒ–</span>
                <span>è§è¯æˆé•¿</span>
            </div>
        </div>
    </footer>

    <script>
        // æƒ…ç»ªæ—¥è®°åº”ç”¨
        class JournalApp {
            constructor() {
                this.currentDate = new Date();
                this.selectedDate = null;
                this.releases = JSON.parse(localStorage.getItem('sedonaReleases') || '[]');
                this.journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
                this.currentAnalysis = null; // å­˜å‚¨å½“å‰åˆ†æç»“æœç”¨äºå¤åˆ¶
                this.selectedTimeRange = 'all'; // é»˜è®¤é€‰æ‹©å…¨éƒ¨æ—¶é—´
                
                this.init();
            }

            init() {
                try {
                    this.updateStatistics();
                    this.renderCalendar();
                    this.renderEmotionChart();
                    this.renderAchievements();
                    this.renderJournalEntries();
                    this.bindEvents();
                    
                    // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸä¸ºé»˜è®¤å€¼
                    document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                }
            }

            bindEvents() {
                // æ—¥å†å¯¼èˆª
                document.getElementById('prevMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.renderCalendar();
                });

                document.getElementById('nextMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.renderCalendar();
                });

                // æ—¶é—´èŒƒå›´æŒ‰é’®åˆ‡æ¢
                document.querySelectorAll('.time-range-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.selectedTimeRange = btn.dataset.range;
                    });
                });
                
                // AIåˆ†æ
                document.getElementById('aiAnalysisBtn').addEventListener('click', () => {
                    this.generateAIAnalysis();
                });

                // å¤åˆ¶åˆ†æç»“æœ
                document.getElementById('copyAnalysisBtn').addEventListener('click', () => {
                    this.copyAnalysisResult();
                });

                // æ–°å»ºæ—¥è®°
                document.getElementById('newEntryBtn').addEventListener('click', () => {
                    this.showJournalModal();
                });

                // æ¨¡æ€æ¡†æ§åˆ¶
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.hideJournalModal();
                });

                document.getElementById('cancelBtn').addEventListener('click', () => {
                    this.hideJournalModal();
                });

                // æƒ…ç»ªæ ‡ç­¾é€‰æ‹©
                document.querySelectorAll('.emotion-tag').forEach(tag => {
                    tag.addEventListener('click', () => {
                        tag.classList.toggle('bg-orange-200');
                        tag.classList.toggle('border-orange-400');
                    });
                });

                // è¡¨å•æäº¤
                document.getElementById('journalForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveJournalEntry();
                });

                // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                document.getElementById('journalModal').addEventListener('click', (e) => {
                    if (e.target.id === 'journalModal') {
                        this.hideJournalModal();
                    }
                });
            }

            updateStatistics() {
                const totalReleases = this.releases.length;
                const streakDays = this.calculateStreak();
                const thisMonth = this.releases.filter(r => {
                    const releaseDate = new Date(r.timestamp);
                    const now = new Date();
                    return releaseDate.getMonth() === now.getMonth() && 
                           releaseDate.getFullYear() === now.getFullYear();
                }).length;
                const milestones = this.calculateMilestones();

                document.getElementById('totalReleases').textContent = totalReleases;
                document.getElementById('streakDays').textContent = streakDays;
                document.getElementById('thisMonth').textContent = thisMonth;
                document.getElementById('milestones').textContent = milestones.achieved.length;
            }

            calculateStreak() {
                if (this.releases.length === 0) return 0;
                
                const today = new Date();
                let streak = 0;
                let currentDate = new Date(today);
                
                while (true) {
                    const dateStr = currentDate.toDateString();
                    const hasRelease = this.releases.some(r => 
                        new Date(r.timestamp).toDateString() === dateStr
                    );
                    
                    if (hasRelease) {
                        streak++;
                        currentDate.setDate(currentDate.getDate() - 1);
                    } else {
                        break;
                    }
                }
                
                return streak;
            }

            calculateMilestones() {
                const milestones = [
                    { id: 'first-release', name: 'åˆæ¬¡é‡Šæ”¾', description: 'å®Œæˆç¬¬ä¸€æ¬¡æƒ…ç»ªé‡Šæ”¾', condition: () => this.releases.length >= 1 },
                    { id: 'week-streak', name: 'ä¸€å‘¨åšæŒ', description: 'è¿ç»­7å¤©è¿›è¡Œé‡Šæ”¾', condition: () => this.calculateStreak() >= 7 },
                    { id: 'month-streak', name: 'æœˆåº¦åšæŒ', description: 'è¿ç»­30å¤©è¿›è¡Œé‡Šæ”¾', condition: () => this.calculateStreak() >= 30 },
                    { id: 'hundred-releases', name: 'ç™¾æ¬¡é‡Šæ”¾', description: 'å®Œæˆ100æ¬¡æƒ…ç»ªé‡Šæ”¾', condition: () => this.releases.length >= 100 },
                    { id: 'all-emotions', name: 'æƒ…ç»ªæ¢ç´¢è€…', description: 'ä½“éªŒè¿‡æ‰€æœ‰æƒ…ç»ªç±»å‹', condition: () => this.getExperiencedEmotions().length >= 5 },
                    { id: 'insight-master', name: 'æ´å¯Ÿå¤§å¸ˆ', description: 'è®°å½•50æ¬¡æ·±åˆ»çš„é‡Šæ”¾æ„Ÿæ‚Ÿ', condition: () => this.journalEntries.length >= 50 }
                ];

                const achieved = milestones.filter(m => m.condition());
                return { achieved, all: milestones };
            }

            getExperiencedEmotions() {
                const emotions = new Set();
                this.releases.forEach(release => {
                    release.emotions.forEach(emotion => emotions.add(emotion));
                });
                return Array.from(emotions);
            }

            renderCalendar() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                // æ›´æ–°æœˆä»½æ˜¾ç¤º
                const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                                  'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
                document.getElementById('currentMonth').textContent = `${year}å¹´ ${monthNames[month]}`;

                // ç”Ÿæˆæ—¥å†
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                const calendarGrid = document.getElementById('calendarGrid');
                calendarGrid.innerHTML = '';

                for (let i = 0; i < 42; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day w-10 h-10 rounded-full flex items-center justify-center text-sm';
                    dayElement.textContent = date.getDate();
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰é‡Šæ”¾è®°å½•
                    const hasRelease = this.releases.some(release => 
                        new Date(release.timestamp).toDateString() === date.toDateString()
                    );
                    
                    if (hasRelease) {
                        dayElement.classList.add('has-release');
                    } else if (date.getMonth() !== month) {
                        dayElement.classList.add('text-gray-300');
                    }
                    
                    dayElement.addEventListener('click', (e) => {
                        this.selectDate(date, e.currentTarget);
                    });
                    
                    calendarGrid.appendChild(dayElement);
                }
            }

            selectDate(date, targetEl) {
                // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                
                // æ·»åŠ æ–°çš„é€‰ä¸­çŠ¶æ€
                if (targetEl) targetEl.classList.add('selected');
                this.selectedDate = date;
                
                // æ˜¾ç¤ºè¯¥æ—¥æœŸçš„é‡Šæ”¾è®°å½•
                this.showDateReleases(date);
            }

            showDateReleases(date) {
                const dayReleases = this.releases.filter(release => 
                    new Date(release.timestamp).toDateString() === date.toDateString()
                );
                
                if (dayReleases.length > 0) {
                    // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºä¸€ä¸ªæ¨¡æ€æ¡†æˆ–ä¾§è¾¹æ æ¥å±•ç¤ºå½“å¤©çš„é‡Šæ”¾è®°å½•
                    console.log(`${date.toDateString()} çš„é‡Šæ”¾è®°å½•:`, dayReleases);
                }
            }

            renderEmotionChart() {
                const chartDom = document.getElementById('emotionChart');
                
                // æ£€æŸ¥ echarts æ˜¯å¦åŠ è½½æˆåŠŸ
                if (typeof echarts === 'undefined') {
                    chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">å›¾è¡¨åŠ è½½ä¸­...</div>';
                    return;
                }
                
                const myChart = echarts.init(chartDom);

                // å‡†å¤‡æ—¶é—´çº¿æ•°æ®ï¼ˆæœ€è¿‘30å¤©ï¼‰
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                // æŒ‰æ—¥æœŸåˆ†ç»„ç»Ÿè®¡æƒ…ç»ª
                const dateEmotionMap = {};
                this.releases.forEach(release => {
                    const releaseDate = new Date(release.timestamp);
                    if (releaseDate >= thirtyDaysAgo) {
                        const dateStr = releaseDate.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
                        if (!dateEmotionMap[dateStr]) {
                            dateEmotionMap[dateStr] = {};
                        }
                        if (release.emotions && Array.isArray(release.emotions)) {
                            release.emotions.forEach(emotion => {
                                const emotionName = this.getEmotionName(emotion);
                                dateEmotionMap[dateStr][emotionName] = (dateEmotionMap[dateStr][emotionName] || 0) + 1;
                            });
                        }
                    }
                });

                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                if (Object.keys(dateEmotionMap).length === 0) {
                    chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">æš‚æ— æƒ…ç»ªæ•°æ®</div>';
                    return;
                }

                // æå–æ‰€æœ‰æƒ…ç»ªç±»å‹
                const allEmotions = new Set();
                Object.values(dateEmotionMap).forEach(emotions => {
                    Object.keys(emotions).forEach(emotion => allEmotions.add(emotion));
                });

                // ç”Ÿæˆæ—¥æœŸåºåˆ—å’Œæ¯ä¸ªæƒ…ç»ªçš„æ•°æ®
                const dates = Object.keys(dateEmotionMap).sort((a, b) => {
                    const [aM, aD] = a.split('/').map(Number);
                    const [bM, bD] = b.split('/').map(Number);
                    return (aM * 100 + aD) - (bM * 100 + bD);
                });

                const series = Array.from(allEmotions).map(emotion => ({
                    name: emotion,
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: function(data) {
                        // ç‚¹çš„å¤§å°æ ¹æ®æ¬¡æ•°å˜åŒ–ï¼Œæœ€å°6ï¼Œæœ€å¤§20
                        return Math.max(6, Math.min(20, 6 + data * 3));
                    },
                    data: dates.map(date => dateEmotionMap[date][emotion] || 0),
                    lineStyle: {
                        width: 2.5
                    },
                    itemStyle: {
                        borderWidth: 2,
                        borderColor: '#fff'
                    },
                    emphasis: {
                        focus: 'series',
                        scale: 1.3
                    }
                }));

                const option = {
                    title: {
                        text: 'æœ€è¿‘30å¤©æƒ…ç»ªè¶‹åŠ¿',
                        left: 'center',
                        textStyle: {
                            fontSize: 14,
                            color: '#374151'
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        borderColor: '#E5E7EB',
                        textStyle: {
                            color: '#374151'
                        }
                    },
                    legend: {
                        bottom: 10,
                        textStyle: {
                            fontSize: 11
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: dates,
                        axisLabel: {
                            fontSize: 11,
                            rotate: 45
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'æ¬¡æ•°',
                        minInterval: 1,
                        axisLabel: {
                            fontSize: 11
                        }
                    },
                    series: series,
                    color: [
                        '#F97316', '#EC4899', '#8B5CF6', '#10B981', '#3B82F6', '#F59E0B',
                        '#EF4444', '#06B6D4', '#84CC16', '#F43F5E', '#14B8A6', '#A855F7'
                    ]
                };

                myChart.setOption(option);
                
                // å“åº”çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', () => {
                    myChart.resize();
                });
            }

            getEmotionName(emotion) {
                const names = {
                    anxiety: 'ç„¦è™‘',
                    anger: 'æ„¤æ€’',
                    sadness: 'æ‚²ä¼¤',
                    fear: 'ææƒ§',
                    insecurity: 'è‡ªå‘',
                    guilt: 'æ„§ç–š',
                    frustration: 'æŒ«è´¥',
                    lonely: 'å­¤ç‹¬',
                    jealousy: 'å«‰å¦’',
                    shame: 'ç¾æ„§',
                    pressure: 'å‹åŠ›',
                    confused: 'å›°æƒ‘',
                    helpless: 'æ— åŠ©',
                    regret: 'åæ‚”',
                    restless: 'çƒ¦èº',
                    peace: 'å¹³é™',
                    custom: 'å…¶ä»–'
                };
                return names[emotion] || emotion;
            }

            getSensationName(sensation) {
                const names = {
                    chest: 'ğŸ’” èƒ¸é—·å‹æŠ‘',
                    head: 'ğŸ¤• å¤´éƒ¨ç´§ç»·',
                    stomach: 'ğŸ˜£ èƒƒéƒ¨ä¸é€‚',
                    shoulder: 'ğŸ’ª è‚©é¢ˆç´§å¼ ',
                    throat: 'ğŸ˜¶ å–‰å’™å µå¡',
                    back: 'ğŸ¦´ åèƒŒæ²‰é‡',
                    heart: 'ğŸ’— å¿ƒè·³åŠ é€Ÿ',
                    breathing: 'ğŸ˜®â€ğŸ’¨ å‘¼å¸æ€¥ä¿ƒ',
                    hands: 'ğŸ‘ æ‰‹å¿ƒå‡ºæ±—',
                    limbs: 'ğŸ¦µ å››è‚¢æ— åŠ›',
                    face: 'ğŸ˜³ é¢éƒ¨å‘çƒ­',
                    tense: 'ğŸ˜¬ è‚Œè‚‰ç´§ç»·',
                    cold: 'ğŸ¥¶ æ‰‹è„šå†°å‡‰',
                    dizzy: 'ğŸ˜µ å¤´æ™•ç›®çœ©',
                    other: 'âœ¨ å…¶ä»–æ„Ÿå—'
                };
                return names[sensation] || sensation;
            }

            getResponseName(response) {
                const names = {
                    yes: 'æ˜¯çš„',
                    trying: 'å°è¯•ä¸­',
                    'not-sure': 'ä¸ç¡®å®š',
                    working: 'åŠªåŠ›ä¸­',
                    now: 'ç°åœ¨',
                    'when-ready': 'å‡†å¤‡å¥½æ—¶'
                };
                return names[response] || response;
            }

            formatJournalContent(content) {
                if (!content) return '';
                
                let formatted = content;
                
                // ç¾åŒ–èº«ä½“æ„Ÿå—
                formatted = formatted.replace(/èº«ä½“æ„Ÿå—ï¼š(\w+)/g, (match, sensation) => {
                    return `<div class="mb-3"><span class="text-gray-500 text-sm">èº«ä½“æ„Ÿå—</span><div class="mt-1 inline-block px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-sm">${this.getSensationName(sensation)}</div></div>`;
                });
                
                // ç¾åŒ–é‡Šæ”¾è¿‡ç¨‹
                formatted = formatted.replace(/é‡Šæ”¾è¿‡ç¨‹ï¼š\n([\s\S]*?)(?=\n\n|é‡Šæ”¾æ„Ÿæ‚Ÿ|$)/g, (match, steps) => {
                    const stepLines = steps.trim().split('\n');
                    const stepsHtml = stepLines.map(line => {
                        const stepMatch = line.match(/(\d+)\.\s*(.+?)ï¼š([\w-]+)/);
                        if (stepMatch) {
                            const [, num, stepName, response] = stepMatch;
                            return `<div class="flex items-center space-x-2 py-1">
                                <span class="w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs font-medium">${num}</span>
                                <span class="text-gray-600">${stepName}</span>
                                <span class="text-green-600 font-medium">${this.getResponseName(response)}</span>
                            </div>`;
                        }
                        return line;
                    }).join('');
                    return `<div class="mb-3"><span class="text-gray-500 text-sm">é‡Šæ”¾è¿‡ç¨‹</span><div class="mt-2 bg-gray-50 rounded-xl p-3">${stepsHtml}</div></div>`;
                });
                
                // ç¾åŒ–é‡Šæ”¾æ„Ÿæ‚Ÿ
                formatted = formatted.replace(/é‡Šæ”¾æ„Ÿæ‚Ÿï¼š(.+)$/gm, (match, insight) => {
                    return `<div class="mt-3"><span class="text-gray-500 text-sm">é‡Šæ”¾æ„Ÿæ‚Ÿ</span><div class="mt-1 text-gray-700 italic bg-orange-50 rounded-xl p-3 border-l-4 border-orange-300">"${insight.trim()}"</div></div>`;
                });
                
                return formatted;
            }

            renderAchievements() {
                const { achieved, all } = this.calculateMilestones();
                const achievementsGrid = document.getElementById('achievementsGrid');
                
                achievementsGrid.innerHTML = '';
                
                all.forEach(milestone => {
                    const isAchieved = achieved.some(a => a.id === milestone.id);
                    const achievementEl = document.createElement('div');
                    achievementEl.className = `achievement-card glass-effect rounded-xl p-3 text-center border border-white/30 ${isAchieved ? 'milestone-badge' : 'opacity-50'}`;
                    
                    achievementEl.innerHTML = `
                        <h4 class="text-sm font-semibold text-gray-800 mb-1">${milestone.name}</h4>
                        <p class="text-xs text-gray-600 leading-tight mb-2">${milestone.description}</p>
                        ${isAchieved ? '<div class="text-xs text-green-600 font-semibold">âœ“ å·²è·å¾—</div>' : '<div class="text-xs text-gray-400">â—‹ æœªè§£é”</div>'}
                    `;
                    
                    achievementsGrid.appendChild(achievementEl);
                });
            }

            renderJournalEntries() {
                const entriesContainer = document.getElementById('journalEntries');
                
                if (this.journalEntries.length === 0) {
                    entriesContainer.innerHTML = `
                        <div class="text-center py-12">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">è¿˜æ²¡æœ‰æ—¥è®°è®°å½•</h3>
                            <p class="text-gray-500 text-sm">å¼€å§‹è®°å½•ä½ çš„é‡Šæ”¾æ„Ÿæ‚Ÿå§</p>
                        </div>
                    `;
                    return;
                }

                entriesContainer.innerHTML = '';
                
                this.journalEntries.slice().reverse().forEach((entry, index) => {
                    const entryEl = document.createElement('div');
                    entryEl.className = 'journal-card glass-effect rounded-2xl p-5 border border-white/30';
                    
                    const date = new Date(entry.date).toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                    
                    const emotionTags = (entry.emotions || []).map(e => 
                        `<span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-orange-100 to-pink-100 text-orange-700 rounded-full text-sm">
                            ${this.getEmotionName(e)}
                        </span>`
                    ).join('');
                    
                    // æ ¼å¼åŒ–å†…å®¹
                    const formattedContent = this.formatJournalContent(entry.content);
                    const entryId = `entry-${entry.id}`;
                    
                    entryEl.innerHTML = `
                        <div class="flex items-start justify-between" onclick="journalApp.toggleEntry('${entryId}')">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="text-gray-600 font-medium text-base">${date}</span>
                                    <svg class="expand-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${emotionTags || '<span class="text-gray-400 text-sm">æ— æƒ…ç»ªæ ‡ç­¾</span>'}
                                </div>
                            </div>
                            <button class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-all ml-2" onclick="event.stopPropagation(); journalApp.deleteEntry('${entry.id}')" title="åˆ é™¤">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                        <div id="${entryId}" class="journal-content">
                            <div class="text-gray-700 leading-relaxed">${formattedContent}</div>
                        </div>
                    `;
                    
                    entriesContainer.appendChild(entryEl);
                });
            }

            showJournalModal() {
                document.getElementById('journalModal').classList.remove('hidden');
                
                anime({
                    targets: '#journalModal > div',
                    scale: [0.8, 1],
                    opacity: [0, 1],
                    duration: 300,
                    easing: 'easeOutBack'
                });
            }

            hideJournalModal() {
                anime({
                    targets: '#journalModal > div',
                    scale: [1, 0.8],
                    opacity: [1, 0],
                    duration: 200,
                    easing: 'easeInBack',
                    complete: () => {
                        document.getElementById('journalModal').classList.add('hidden');
                        this.resetJournalForm();
                    }
                });
            }

            resetJournalForm() {
                document.getElementById('journalForm').reset();
                document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
                document.querySelectorAll('.emotion-tag').forEach(tag => {
                    tag.classList.remove('bg-orange-200', 'border-orange-400');
                });
            }

            saveJournalEntry() {
                const date = document.getElementById('journalDate').value;
                const content = document.getElementById('journalContent').value;
                const selectedEmotions = Array.from(document.querySelectorAll('.emotion-tag.bg-orange-200')).map(tag => tag.dataset.emotion);
                
                if (!content.trim()) {
                    alert('è¯·è¾“å…¥æ—¥è®°å†…å®¹');
                    return;
                }

                const entry = {
                    id: Date.now().toString(),
                    date: date,
                    emotions: selectedEmotions,
                    content: content.trim()
                };

                this.journalEntries.push(entry);
                localStorage.setItem('journalEntries', JSON.stringify(this.journalEntries));
                
                this.hideJournalModal();
                this.renderJournalEntries();
                this.showSuccessMessage('æ—¥è®°ä¿å­˜æˆåŠŸ ğŸ“');
            }

            toggleEntry(entryId) {
                const content = document.getElementById(entryId);
                const card = content.closest('.journal-card');
                const icon = card.querySelector('.expand-icon');
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    card.classList.remove('expanded');
                    icon.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                    card.classList.add('expanded');
                    icon.classList.add('expanded');
                }
            }

            deleteEntry(entryId) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ')) {
                    this.journalEntries = this.journalEntries.filter(entry => entry.id !== entryId);
                    localStorage.setItem('journalEntries', JSON.stringify(this.journalEntries));
                    this.renderJournalEntries();
                    this.showSuccessMessage('æ—¥è®°å·²åˆ é™¤');
                }
            }

            showSuccessMessage(message) {
                const messageEl = document.createElement('div');
                messageEl.textContent = message;
                messageEl.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-lg z-50';
                
                document.body.appendChild(messageEl);
                
                anime({
                    targets: messageEl,
                    scale: [0, 1],
                    opacity: [0, 1],
                    duration: 300,
                    easing: 'easeOutBack',
                    complete: () => {
                        setTimeout(() => {
                            anime({
                                targets: messageEl,
                                scale: [1, 0],
                                opacity: [1, 0],
                                duration: 300,
                                easing: 'easeInBack',
                                complete: () => {
                                    document.body.removeChild(messageEl);
                                }
                            });
                        }, 1500);
                    }
                });
            }

            // AIåˆ†æåŠŸèƒ½
            async generateAIAnalysis() {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
                if (this.releases.length === 0) {
                    alert('æš‚æ— é‡Šæ”¾è®°å½•ï¼Œæ— æ³•è¿›è¡Œåˆ†æ');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('aiAnalysisEmpty').classList.add('hidden');
                document.getElementById('aiAnalysisResult').classList.add('hidden');
                document.getElementById('aiAnalysisLoading').classList.remove('hidden');

                try {
                    // å‡†å¤‡åˆ†ææ•°æ®
                    const timeRange = this.selectedTimeRange;
                    const analysisData = this.prepareAnalysisData(timeRange);
                    
                    // è·å–APIé…ç½®
                    const apiKey = localStorage.getItem('aiApiKey');
                    const apiEndpoint = localStorage.getItem('aiApiEndpoint') || 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
                    const apiModel = localStorage.getItem('aiApiModel') || 'doubao-seed-1-6-251015';

                    if (!apiKey) {
                        throw new Error('è¯·å…ˆåœ¨è®¾ç½®é¡µé¢é…ç½®AI APIå¯†é’¥');
                    }

                    // è°ƒç”¨AI API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: apiModel,
                            messages: [
                                {
                                    role: 'system',
                                    content: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¿ƒç†å’¨è¯¢å¸ˆï¼Œæ“…é•¿æƒ…ç»ªåˆ†æå’Œåœ£å¤šçº³é‡Šæ”¾æ³•ã€‚è¯·ç”¨Markdownæ ¼å¼æä¾›åˆ†ææŠ¥å‘Šï¼Œä½¿ç”¨æ ‡é¢˜ã€åˆ—è¡¨ã€åŠ ç²—ç­‰æ ¼å¼è®©å†…å®¹æ›´æ¸…æ™°æ˜“è¯»ã€‚'
                                },
                                {
                                    role: 'user',
                                    content: `è¯·åˆ†ææˆ‘çš„æƒ…ç»ªé‡Šæ”¾æ•°æ®ï¼š\n\n${analysisData}\n\nè¯·ä»ä»¥ä¸‹å‡ ä¸ªç»´åº¦è¿›è¡Œåˆ†æï¼š\n1. æ€»ä½“æƒ…ç»ªè¶‹åŠ¿å’Œå˜åŒ–\n2. ä¸»è¦æƒ…ç»ªæ¨¡å¼è¯†åˆ«\n3. é‡Šæ”¾æ•ˆæœè¯„ä¼°\n4. å…·ä½“å»ºè®®å’Œé¼“åŠ±\n\nè¯·ç”¨Markdownæ ¼å¼è¾“å‡ºï¼Œç”¨æ¸©æš–ã€é¼“åŠ±çš„è¯­æ°”ï¼Œæä¾›æ·±å…¥ä¸”å®ç”¨çš„åˆ†æã€‚`
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 1500
                        })
                    });

                    if (!response.ok) {
                        throw new Error('AIåˆ†æè¯·æ±‚å¤±è´¥');
                    }

                    const data = await response.json();
                    this.currentAnalysis = data.choices[0].message.content;

                    // ä½¿ç”¨Markdownæ¸²æŸ“
                    const html = marked.parse(this.currentAnalysis);
                    const safeHtml = DOMPurify.sanitize(html);

                    // æ˜¾ç¤ºåˆ†æç»“æœ
                    document.getElementById('aiAnalysisLoading').classList.add('hidden');
                    document.getElementById('aiAnalysisResult').classList.remove('hidden');
                    document.getElementById('aiAnalysisContent').innerHTML = safeHtml;

                } catch (error) {
                    console.error('AIåˆ†æå¤±è´¥:', error);
                    document.getElementById('aiAnalysisLoading').classList.add('hidden');
                    document.getElementById('aiAnalysisResult').classList.remove('hidden');
                    document.getElementById('aiAnalysisContent').innerHTML = `
                        <p class="text-red-600"><strong>åˆ†æå¤±è´¥ï¼š</strong>${error.message}</p>
                        <p class="text-gray-600 mt-2">è¯·æ£€æŸ¥APIé…ç½®æ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç¨åå†è¯•ã€‚</p>
                    `;
                }
            }

            // å¤åˆ¶åˆ†æç»“æœ
            async copyAnalysisResult() {
                if (!this.currentAnalysis) {
                    alert('æš‚æ— åˆ†æç»“æœå¯å¤åˆ¶');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(this.currentAnalysis);
                    const btn = document.getElementById('copyAnalysisBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        å·²å¤åˆ¶
                    `;
                    btn.classList.add('bg-green-50', 'text-green-600');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-50', 'text-green-600');
                    }, 2000);
                } catch (error) {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶å†…å®¹');
                }
            }

            prepareAnalysisData(timeRange = 'all') {
                const now = new Date();
                let startDate;
                let timeRangeText = '';

                // æ ¹æ®æ—¶é—´èŒƒå›´ç­›é€‰æ•°æ®
                switch(timeRange) {
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        timeRangeText = 'æœ€è¿‘ä¸€å‘¨';
                        break;
                    case 'month':
                        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        timeRangeText = 'æœ€è¿‘ä¸€æœˆ';
                        break;
                    case 'quarter':
                        startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        timeRangeText = 'æœ€è¿‘ä¸‰æœˆ';
                        break;
                    default:
                        startDate = new Date(0);
                        timeRangeText = 'å…¨éƒ¨æ—¶é—´';
                }

                // ç­›é€‰æ—¶é—´èŒƒå›´å†…çš„æ•°æ®
                const filteredReleases = this.releases.filter(r => new Date(r.timestamp) >= startDate);

                if (filteredReleases.length === 0) {
                    throw new Error(`${timeRangeText}æ²¡æœ‰é‡Šæ”¾è®°å½•`);
                }

                // ç»Ÿè®¡æƒ…ç»ªåˆ†å¸ƒ
                const emotionCounts = {};
                filteredReleases.forEach(r => {
                    if (r.emotions && Array.isArray(r.emotions)) {
                        r.emotions.forEach(e => {
                            const emotionName = this.getEmotionName(e);
                            emotionCounts[emotionName] = (emotionCounts[emotionName] || 0) + 1;
                        });
                    }
                });

                // ç»Ÿè®¡èº«ä½“æ„Ÿå—
                const sensationCounts = {};
                filteredReleases.forEach(r => {
                    if (r.sensations && r.sensations.length > 0) {
                        r.sensations.forEach(s => {
                            const sensationName = this.getSensationName(s);
                            sensationCounts[sensationName] = (sensationCounts[sensationName] || 0) + 1;
                        });
                    }
                });

                // æŒ‰æ—¥æœŸæ’åº
                const sortedReleases = filteredReleases.sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp)
                );

                // ç”Ÿæˆæ—¶é—´çº¿
                const timeline = sortedReleases.slice(-10).map(r => {
                    const date = new Date(r.timestamp).toLocaleDateString('zh-CN', { 
                        month: 'numeric', day: 'numeric' 
                    });
                    const emotions = (r.emotions || []).map(e => this.getEmotionName(e)).join('ã€');
                    const sensations = (r.sensations || []).map(s => this.getSensationName(s)).join('ã€');
                    return `${date}: ${emotions}${sensations ? ' | ' + sensations : ''}`;
                }).join('\n');

                // ç”Ÿæˆåˆ†ææ–‡æœ¬
                return `
## åˆ†ææ—¶æ®µï¼š${timeRangeText}

### åŸºç¡€æ•°æ®
- é‡Šæ”¾æ¬¡æ•°ï¼š${filteredReleases.length}æ¬¡
- æ—¶é—´è·¨åº¦ï¼š${sortedReleases[0] ? new Date(sortedReleases[0].timestamp).toLocaleDateString('zh-CN') : ''} è‡³ ${sortedReleases[sortedReleases.length-1] ? new Date(sortedReleases[sortedReleases.length-1].timestamp).toLocaleDateString('zh-CN') : ''}
- å¹³å‡é¢‘ç‡ï¼šæ¯${Math.round((now - new Date(sortedReleases[0]?.timestamp || now)) / (1000 * 60 * 60 * 24) / filteredReleases.length) || 1}å¤©ä¸€æ¬¡

### æƒ…ç»ªåˆ†å¸ƒ
${Object.entries(emotionCounts).sort((a, b) => b[1] - a[1]).map(([emotion, count]) => 
    `- ${emotion}: ${count}æ¬¡ (${((count / filteredReleases.length) * 100).toFixed(1)}%)`
).join('\n')}

### èº«ä½“æ„Ÿå—ç»Ÿè®¡
${Object.keys(sensationCounts).length > 0 ? 
    Object.entries(sensationCounts).sort((a, b) => b[1] - a[1]).map(([sensation, count]) => 
        `- ${sensation}: ${count}æ¬¡`
    ).join('\n') : 
    '- æš‚æ— èº«ä½“æ„Ÿå—è®°å½•'
}

### æœ€è¿‘é‡Šæ”¾æ—¶é—´çº¿ï¼ˆæœ€å¤šæ˜¾ç¤º10æ¡ï¼‰
${timeline}
                `.trim();
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        let journalApp;
        document.addEventListener('DOMContentLoaded', () => {
            journalApp = new JournalApp();
        });
    </script>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
    <nav class="mobile-nav">
        <a href="index.html">
            <span class="text-sm font-medium">é‡Šæ”¾</span>
        </a>
        <a href="journal.html" class="active">
            <span class="text-sm font-medium">æ—¥è®°</span>
        </a>
        <a href="wisdom.html">
            <span class="text-sm font-medium">æ™ºæ…§</span>
        </a>
        <a href="chat.html">
            <span class="text-sm font-medium">å¯¹è¯</span>
        </a>
        <a href="settings.html">
            <span class="text-sm font-medium">è®¾ç½®</span>
        </a>
    </nav>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="backgroundMusic" loop preload="auto" volume="0.3">
        <source src="./resources/back.mp4" type="video/mp4">
    </audio>
</body>
</html>